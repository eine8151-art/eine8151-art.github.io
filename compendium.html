<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compendium â€“ ë„ê° (ì‹ ê·œ ìŠ¤íƒ¯ ì²´ê³„)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f0f12;
      --panel:#18181f;
      --panel2:#121219;
      --text:#e8e6e3;
      --muted:#b7b3ad;
      --gold:#d4af37;
      --gold2:#b8922b;
      --card:rgba(212,175,55,.35)
    }

    *{
      box-sizing:border-box
    }

    body{
      margin:0;
      background:radial-gradient(1000px 600px at 70% -10%, rgba(212,175,55,.12), transparent 70%),var(--bg);
      color:var(--text);
      font-family:'Noto Sans KR',system-ui,sans-serif
    }

    a{
      color:inherit;
      text-decoration:none
    }

    .wrap{
      display:grid;
      grid-template-columns:240px 1fr;
      gap:14px;
      padding:16px
    }

    .side{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:14px
    }

    .main{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:14px;
      position:relative
    }

    .menu{display:flex;flex-direction:column;gap:8px}
    .mbtn{padding:10px 12px;border:1px solid rgba(255,255,255,.08);border-radius:10px;background:rgba(255,255,255,.02);cursor:pointer;text-align:left}
    .mbtn.active, .mbtn:hover{border-color:var(--card)}

    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    h1{font-family:'Cinzel',serif;margin:0}

    .tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);cursor:pointer}
    .btn.gold{background:linear-gradient(180deg,var(--gold),var(--gold2));color:#111;border:none}
    input,select{background:#11141a;color:var(--text);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:8px}

    .chips{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0 12px}
    .chip{padding:6px 10px;border:1px solid rgba(255,255,255,.18);border-radius:999px;background:rgba(255,255,255,.04);cursor:pointer;font-size:.9rem}
    .chip.active{background:rgba(212,175,55,.15);border-color:var(--card)}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .card{border:1px solid var(--card);border-radius:12px;overflow:hidden;background:rgba(255,255,255,.02);cursor:pointer;transition:.2s}
    .card:hover{transform:translateY(-3px)}
    .thumb{height:120px;background:#24242d center/cover no-repeat}
    .card .meta{padding:8px}
    .tag{font-size:.75rem;color:var(--muted)}
    .badge{display:inline-block;min-width:26px;text-align:center;font-weight:800;border:1px solid rgba(212,175,55,.45);border-radius:6px;padding:1px 6px;margin-left:6px;color:#e9e1c9}
    /* Tier coloring by rank */
    .badge[data-rank="EX"], .badge[data-rank^="S"]{background:rgba(212,175,55,.18)}
    .badge[data-rank^="A"]{background:rgba(102,187,106,.18)}
    .badge[data-rank^="B"]{background:rgba(100,181,246,.18)}
    .badge[data-rank^="C"]{background:rgba(255,202,40,.12)}
    .badge[data-rank^="D"]{background:rgba(239,83,80,.12)}
    .badge[data-rank^="F"]{background:rgba(176,190,197,.18);color:#e0e6e9}

    /* Icon preview */
    .prev{width:72px;height:72px;border-radius:10px;border:1px solid rgba(212,175,55,.35);background:#1a1d25;object-fit:cover}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* Drawer */
    .drawer{position:absolute;top:0;right:0;width:min(540px,100%);height:100%;background:linear-gradient(180deg,var(--panel),var(--panel2));border-left:1px solid rgba(255,255,255,.08);padding:14px;display:none}
    .drawer.show{display:block}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center}
    textarea{min-height:120px}
    .rows{display:grid;grid-template-columns:1fr 1fr;gap:8px}

    .statrow{display:grid;grid-template-columns:120px 1fr 70px 80px;gap:6px;align-items:center}
    .statrow small{color:var(--muted)}
    .bar{height:8px;background:#0d0f14;border:1px solid rgba(255,255,255,.08);border-radius:99px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--gold),var(--gold2));width:50%}

    .empty{border:2px dashed rgba(255,255,255,.1);border-radius:12px;padding:24px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <aside class="side">
      <div class="menu">
        <button class="mbtn active" data-filter="all">ì „ì²´</button>
        <button class="mbtn" data-filter="trait">íŠ¹ì„±</button>
        <button class="mbtn" data-filter="tech">ê¸°ìˆ </button>
        <button class="mbtn" data-filter="magic">ë§ˆë²•</button>
        <button class="mbtn" data-filter="skill">ìŠ¤í‚¬</button>
        <button class="mbtn" data-filter="authority">ê¶ŒëŠ¥</button>
        <button class="mbtn" data-filter="blessing">ê°€í˜¸</button>
        <button class="mbtn" data-filter="proficiency">ìˆ™ë ¨ë„</button>
        <hr style="border-color:rgba(255,255,255,.08)">
        <button class="mbtn only-admin" id="addBtn">+ ìƒˆ í•­ëª©</button>
        <label class="mbtn">ë¶ˆëŸ¬ì˜¤ê¸°(JSON)
          <input class="only-admin" type="file" id="importInput" accept="application/json" hidden>
        </label>
        <button class="mbtn" id="exportBtn">ë‚´ë³´ë‚´ê¸°(JSON)</button>
        <a class="mbtn" href="index.html">â† ë©”ì¸</a>
      </div>
    </aside>

    <main class="main">
      <header>
        <h1>ë„ê°</h1>
        <div class="tools">
          <input id="q" placeholder="ê²€ìƒ‰(ì´ë¦„, íƒœê·¸, ë“±ê¸‰)" style="min-width:220px">
          <select id="sortSel" title="ì •ë ¬">
            <option value="name">ê°€ë‚˜ë‹¤ìˆœ</option>
            <option value="tag">íƒœê·¸ ê·¸ë£¹ ìˆœ</option>
            <option value="rankDesc">ë“±ê¸‰ (ê³  â†’ ì €)</option>
          </select>
          <select id="rankSel" title="ë“±ê¸‰ í•„í„°">
            <option value="">ë“±ê¸‰ ì „ì²´</option>
            <option value="EX">EX</option><option value="SSS">SSS</option><option value="SS">SS</option><option value="S+">S+</option><option value="S">S</option>
            <option value="A++">A++</option><option value="A+">A+</option><option value="A">A</option><option value="A-">A-</option>
            <option value="B++">B++</option><option value="B+">B+</option><option value="B">B</option><option value="B-">B-</option>
            <option value="C++">C++</option><option value="C+">C+</option><option value="C">C</option><option value="C-">C-</option>
            <option value="D++">D++</option><option value="D+">D+</option><option value="D">D</option><option value="D-">D-</option>
            <option value="F++">F++</option><option value="F+">F+</option><option value="F">F</option><option value="F-">F-</option>
          </select>
          <button class="btn" id="clearBtn" title="í•„í„° ì´ˆê¸°í™”">í•„í„° ì´ˆê¸°í™”</button>
        </div>
      </header>
      <div class="chips" id="tagChips"></div>

      <div id="list" class="grid"></div>
      <div id="empty" class="empty" style="display:none">ì•„ì§ ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ì™¼ìª½ì˜ "ìƒˆ í•­ëª©"ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”.</div>

      <aside id="drawer" class="drawer">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong id="dwTitle">í•­ëª©</strong>
          <div>
            <button id="closeDw" class="btn">ë‹«ê¸°</button>
            <button id="saveDw" class="btn gold only-admin">ì €ì¥</button>
          </div>
        </div>
        <div class="kv"><label>ì¢…ë¥˜</label><select id="fType">
          <option value="trait">íŠ¹ì„±</option>
          <option value="tech">ê¸°ìˆ </option>
          <option value="magic">ë§ˆë²•</option>
          <option value="skill">ìŠ¤í‚¬</option>
          <option value="authority">ê¶ŒëŠ¥</option>
          <option value="blessing">ê°€í˜¸</option>
          <option value="proficiency">ìˆ™ë ¨ë„</option>
        </select></div>
        <div class="kv"><label>ì´ë¦„</label><input id="fName"></div>
        <div class="kv"><label>ë“±ê¸‰</label><select id="fRank">
          <option value="">â€” ì—†ìŒ â€”</option>
          <option value="EX">EX</option>
          <option value="SSS">SSS</option>
          <option value="SS">SS</option>
          <option value="S+">S+</option>
          <option value="S">S</option>
          <option value="A++">A++</option>
          <option value="A+">A+</option>
          <option value="A">A</option>
          <option value="A-">A-</option>
          <option value="B++">B++</option>
          <option value="B+">B+</option>
          <option value="B">B</option>
          <option value="B-">B-</option>
          <option value="C++">C++</option>
          <option value="C+">C+</option>
          <option value="C">C</option>
          <option value="C-">C-</option>
          <option value="D++">D++</option>
          <option value="D+">D+</option>
          <option value="D">D</option>
          <option value="D-">D-</option>
          <option value="F++">F++</option>
          <option value="F+">F+</option>
          <option value="F">F</option>
          <option value="F-">F-</option>
        </select></div>

        <!-- â˜… ìƒˆë¡œ ì¶”ê°€: ëœë¤/ì¡°ê±´ ì„¤ì • -->
        <div class="kv">
          <label>ëœë¤ íšë“ í›„ë³´</label>
          <label class="inline">
            <input type="checkbox" id="fRandomCandidate">
            ì´ˆê¸°/ëœë¤ íšë“ í’€ì— í¬í•¨
          </label>
        </div>

        <div class="kv">
          <label>ì¡°ê±´ â€“ ì§ì—…</label>
          <input id="fCondJobs" placeholder="ì˜ˆ: ìš©ì‚¬, ê²€ì‚¬, ê¶ìˆ˜">
        </div>

        <div class="kv">
          <label>ì¡°ê±´ â€“ ì¢…ì¡±</label>
          <input id="fCondRaces" placeholder="ì˜ˆ: ì—˜í”„, í•˜í”„ì—˜í”„">
        </div>

        <div class="kv"><label>ì•„ì´ì½˜</label>
          <div class="inline">
            <input id="fIcon" placeholder="ì´ë¯¸ì§€ URL (ì„ íƒ)">
            <label class="btn">íŒŒì¼ ì—…ë¡œë“œ<input id="fIconFile" type="file" accept="image/*" hidden></label>
          </div>
        </div>
        <div class="kv"><label>ë¯¸ë¦¬ë³´ê¸°</label><img id="iconPreview" class="prev" alt="icon preview"></div>
        <div class="kv"><label>íƒœê·¸</label><input id="fTags" placeholder=",ë¡œ êµ¬ë¶„"></div>
        <div class="kv" style="align-items:start"><label>ì„¤ëª…</label><textarea id="fDesc"></textarea></div>
        <hr style="border-color:rgba(255,255,255,.08);margin:10px 0">
        <div class="rows">
          <div class="statrow"><span>ê·¼ë ¥</span><div class="bar"><span></span></div><input id="mStr" type="number" value="0" title="ê³ ì •ê°’(Â±)"><input id="mStrP" type="number" step="0.1" value="0" placeholder="%" title="% ë³´ì •"></div>
          <div class="statrow"><span>ë‚´êµ¬</span><div class="bar"><span></span></div><input id="mEnd" type="number" value="0"><input id="mEndP" type="number" step="0.1" value="0" placeholder="%"></div>
          <div class="statrow"><span>ë¯¼ì²©</span><div class="bar"><span></span></div><input id="mAgi" type="number" value="0"><input id="mAgiP" type="number" step="0.1" value="0" placeholder="%"></div>
          <div class="statrow"><span>ì§€ë ¥</span><div class="bar"><span></span></div><input id="mInt" type="number" value="0"><input id="mIntP" type="number" step="0.1" value="0" placeholder="%"></div>
          <div class="statrow"><span>ìì›</span><div class="bar"><span></span></div><input id="mMana" type="number" value="0"><input id="mManaP" type="number" step="0.1" value="0" placeholder="%"></div>
            <!-- ğŸ”¹ ì¶”ê°€: í„´ë‹¹ ë§ˆë‚˜ ì¬ìƒ -->
            <div class="statrow">
              <span>ë§ˆë‚˜ ì¬ìƒ</span>
              <div class="bar"><span></span></div>
              <input id="mMpRegen" type="number" value="0" title="í„´ë§ˆë‹¤ íšŒë³µë˜ëŠ” ë§ˆë‚˜ ì–‘ (ê³ ì •ê°’)">
              <span style="font-size:12px;margin-left:4px">/í„´</span>
            </div>
            <div class="statrow"><span>í–‰ìš´</span><div class="bar"><span></span></div><input id="mLuck" type="number" value="0"><input id="mLuckP" type="number" step="0.1" value="0" placeholder="%"></div>
        </div>
        <p style="color:var(--muted);margin-top:6px">â€» ìŠ¤íƒ¯ ë³´ì •ì€ "íŠ¹ì„±" ì¢…ë¥˜ì—ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤. (Â±, % ëª¨ë‘ ì§€ì›) â€” <small>ê¸°ì¡´ í‚¤(atk/def/spd/hp)ì™€ë„ ìë™ í˜¸í™˜</small></p>
      </aside>
    </main>
 </div>

    <!-- API ìœ í‹¸ (getToken, fetchMe, apiGet, apiPost ë“±) -->
    <script src="js/api.js"></script>

    <!-- ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ -->
    <script>
      if (!window.getToken || !getToken()) {
        window.location.href = 'login.html';
      }
    </script>

    <script>
    /* =========================================================
     *  ìƒìˆ˜ / ê³µí†µ DOM ì°¸ì¡°
     * ======================================================= */

    // localStorage í‚¤
    const KEY = 'codex.v1';

    // ë‹¨ì¶• querySelector
    const $ = s => document.querySelector(s);

    // ëª©ë¡ ì˜ì—­ / ë¹„ì–´ìˆì„ ë•Œ ì•ˆë‚´ë¬¸
    const listEl  = $('#list');
    const emptyEl = $('#empty');

    // ì˜¤ë¥¸ìª½ í¸ì§‘ ë“œë¡œì–´
    const drawer = $('#drawer');

    // ê²€ìƒ‰ / í•„í„° / ì •ë ¬ ê´€ë ¨ ìš”ì†Œ
    const q          = $('#q');
    const importInput = $('#importInput');
    const sortSel    = $('#sortSel');
    const rankSel    = $('#rankSel');
    const clearBtn   = $('#clearBtn');
    const tagChips   = $('#tagChips');

    // íƒ€ì… â†’ í•œê¸€ ë¼ë²¨
    const TYPE_LABELS = {
      trait:       'íŠ¹ì„±',
      tech:        'ê¸°ìˆ ',
      magic:       'ë§ˆë²•',
      skill:       'ìŠ¤í‚¬',
      authority:   'ê¶ŒëŠ¥',
      blessing:    'ê°€í˜¸',
      proficiency: 'ìˆ™ë ¨ë„'
    };

    // ë“±ê¸‰ ì •ë ¬ ê¸°ì¤€ (ì•ìœ¼ë¡œ ê°ˆìˆ˜ë¡ ë†’ì€ ë“±ê¸‰)
    const RANK_ORDER = [
      "EX","SSS","SS","S+","S",
      "A++","A+","A","A-",
      "B++","B+","B","B-",
      "C++","C+","C","C-",
      "D++","D+","D","D-",
      "F++","F+","F","F-"
    ];

    // ë“±ê¸‰ ë¬¸ìì—´ â†’ ì¸ë±ìŠ¤ (ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ë†’ì€ ë“±ê¸‰, ë¯¸ì§€ì •ì‹œ 999)
    const rankIndex = r => {
      const i = RANK_ORDER.indexOf(r || '');
      return i < 0 ? 999 : i;
    };

    /* =========================================================
     *  í¼ ìš”ì†Œ ëª¨ìŒ (ë“œë¡œì–´ ë‚´ë¶€)
     * ======================================================= */

    // ë“œë¡œì–´ ì•ˆì˜ ì…ë ¥ ìš”ì†Œë“¤ì„ í•œ ê°ì²´ë¡œ ëª¨ì•„ë‘ 
    const f = {
      type:     $('#fType'),
      name:     $('#fName'),
      icon:     $('#fIcon'),
      iconFile: $('#fIconFile'),
      iconPrev: $('#iconPreview'),
      desc:     $('#fDesc'),
      tags:     $('#fTags'),
      rank:     $('#fRank'),

      // â˜… ëœë¤/ì¡°ê±´ ì„¤ì •
      randomCandidate: $('#fRandomCandidate'),
      condJobs:        $('#fCondJobs'),
      condRaces:       $('#fCondRaces'),

      // ê³ ì •ê°’ ë³´ì •
      mStr:     $('#mStr'),
      mEnd:     $('#mEnd'),
      mAgi:     $('#mAgi'),
      mInt:     $('#mInt'),
      mMana:    $('#mMana'),
      mMpRegen: $('#mMpRegen'),  // ğŸ”¹ ì¶”ê°€: í„´ë‹¹ ë§ˆë‚˜ ì¬ìƒ
      mLuck:    $('#mLuck'),

      // % ë³´ì •
      mStrP:  $('#mStrP'),
      mEndP:  $('#mEndP'),
      mAgiP:  $('#mAgiP'),
      mIntP:  $('#mIntP'),
      mManaP: $('#mManaP'),
      mLuckP: $('#mLuckP')
    };

    /* =========================================================
     *  ë°ì´í„° ë¡œë“œ/ì €ì¥ ìœ í‹¸
     * ======================================================= */

    // ê°„ë‹¨í•œ id ìƒì„±ê¸°
    function uid(){
      return Math.random().toString(36).slice(2, 9);
    }

    // localStorageì—ì„œ ë„ê° ë°ì´í„° ë¡œë“œ
    function load(){
      try{
        return JSON.parse(localStorage.getItem(KEY) || '[]');
      }catch{
        return [];
      }
    }

    // localStorageì— ë„ê° ë°ì´í„° ì €ì¥ (ìºì‹œ ìš©ë„)
    function save(data){
      localStorage.setItem(KEY, JSON.stringify(data));
    }

    // ì‹¤ì œ ë©”ëª¨ë¦¬ ìƒì˜ ë„ê° ë°°ì—´ (ì´ˆê¸°ì—ëŠ” ë¹ˆ ë°°ì—´, init()ì—ì„œ ì±„ì›€)
    let data = [];

    // í˜„ì¬ ë¡œê·¸ì¸ ìœ ì € / ê¶Œí•œ
    let currentUser = null;
    let isAdmin     = false;

    // í˜„ì¬ ë“œë¡œì–´ì—ì„œ í¸ì§‘ ì¤‘ì¸ í•­ëª©
    let current = null;

    // í™œì„±í™”ëœ íƒœê·¸ í•„í„° ì§‘í•© (ì†Œë¬¸ì ê¸°ì¤€)
    const activeTags = new Set();

    /* =========================================================
     *  íƒœê·¸ ì¹©(Chips) ìƒì„± ë° ê´€ë¦¬
     * ======================================================= */

    // ë°ì´í„° ì „ì²´ë¥¼ í›‘ì–´ì„œ íƒœê·¸ ëª©ë¡ì„ ë§Œë“¤ê³  ì¹© UIë¥¼ êµ¬ì„±
    function buildTagChips(){
      const map = new Map();

      // íƒœê·¸ ì¹´ìš´íŠ¸ ì§‘ê³„
      data.forEach(x => {
        (x.tags || '')
          .split(/\s*,\s*/)
          .forEach(t => {
            if(!t) return;
            const k = t.toLowerCase();
            map.set(k, (map.get(k) || 0) + 1);
          });
      });

      // ì •ë ¬ëœ íƒœê·¸ ëª©ë¡ (ìµœëŒ€ 60ê°œê¹Œì§€)
      const tags = [...map.entries()]
        .sort((a, b) => a[0].localeCompare(b[0], 'ko'))
        .slice(0, 60);

      tagChips.innerHTML = '';

      tags.forEach(([t, count]) => {
        const b = document.createElement('button');
        b.className  = 'chip';
        b.textContent = `#${t}`;
        b.title       = `${count}ê°œ í¬í•¨`;

        if(activeTags.has(t)) b.classList.add('active');

        b.onclick = () => {
          if(activeTags.has(t)) activeTags.delete(t);
          else activeTags.add(t);
          render(currentFilter());
        };

        tagChips.appendChild(b);
      });
    }

    /* =========================================================
     *  í˜„ì¬ ì„ íƒëœ ì¢…ë¥˜ í•„í„° (ì¢Œì¸¡ ì‚¬ì´ë“œ ë©”ë‰´)
     * ======================================================= */

    function currentFilter(){
      return document.querySelector('.mbtn.active')?.dataset.filter || 'all';
    }

    /* =========================================================
     *  ê²€ìƒ‰/í•„í„°/ì •ë ¬ì„ ì ìš©í•œ ê²°ê³¼ ë°°ì—´ ê³„ì‚°
     * ======================================================= */

    function filteredSorted(filter){
      const term = (q.value || '').toLowerCase();

      // 1ì°¨ í•„í„°ë§: ì¢…ë¥˜ + ê²€ìƒ‰ì–´(ì´ë¦„/íƒœê·¸/ë“±ê¸‰)
      let arr = data.filter(x =>
        (filter === 'all' || x.type === filter) &&
        (
          x.name.toLowerCase().includes(term) ||
          (x.tags || '').toLowerCase().includes(term) ||
          (x.rank || '').toLowerCase().includes(term)
        )
      );

      // ë“±ê¸‰ í•„í„° ì¶”ê°€ ì ìš©
      if(rankSel.value){
        arr = arr.filter(x => (x.rank || '') === rankSel.value);
      }

      // íƒœê·¸ ì¹© í•„í„° ì ìš©
      if(activeTags.size){
        arr = arr.filter(x => {
          const tags = (x.tags || '')
            .split(/\s*,\s*/)
            .map(s => s.toLowerCase())
            .filter(Boolean);

          for(const t of activeTags){
            if(tags.includes(t)) return true;
          }
          return false;
        });
      }

      // ì •ë ¬ ë°©ì‹ ì ìš©
      const sort = sortSel.value;

      if(sort === 'name'){
        // ì´ë¦„ ê°€ë‚˜ë‹¤ ìˆœ
        arr.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
      }else if(sort === 'tag'){
        // ì²« íƒœê·¸ ê¸°ì¤€ ê·¸ë£¹ ì •ë ¬ â†’ ê·¸ ì•ˆì—ì„œ ì´ë¦„ìˆœ
        const firstTag = o =>
          (o.tags || '')
            .split(/\s*,\s*/)
            .filter(Boolean)[0] || '';

        arr.sort((a, b) =>
          firstTag(a).localeCompare(firstTag(b), 'ko') ||
          a.name.localeCompare(b.name, 'ko')
        );
      }else if(sort === 'rankDesc'){
        // ë“±ê¸‰ ë†’ì€ ìˆœ â†’ ì´ë¦„ìˆœ
        arr.sort((a, b) =>
          rankIndex(a.rank) - rankIndex(b.rank) ||
          a.name.localeCompare(b.name, 'ko')
        );
      }

      return arr;
    }

    /* =========================================================
     *  ë©”ì¸ ëª©ë¡ ë Œë”ë§
     * ======================================================= */

    /**
     * ë„ê° ì¹´ë“œë“¤ì„ í™”ë©´ì— ê·¸ë¦¬ëŠ” í•¨ìˆ˜
     * @param {string} filter - 'all' / 'trait' / 'tech' â€¦ (ì¢Œì¸¡ ì¹´í…Œê³ ë¦¬)
     */
    function render(filter = 'all'){
      const arr = filteredSorted(filter);

      listEl.innerHTML = '';
      emptyEl.style.display = arr.length ? 'none' : 'block';

      arr.forEach(x => {
        const card = document.createElement('div');
        card.className = 'card';
        card.onclick   = () => openDrawer(x.id);

        card.innerHTML = `
          <div class="thumb" style="background-image:url('${x.icon || ''}')"></div>
          <div class="meta">
            <div style="font-weight:700">
              ${x.name}
              ${x.rank
                ? ` <span class="badge" data-rank="${x.rank}">${x.rank}</span>`
                : ''
              }
            </div>
            <div class="tag">
              ${(TYPE_LABELS[x.type] || x.type)} Â· ${(x.tags || '')}
            </div>
          </div>
        `;

        listEl.appendChild(card);
      });
    }

    /* =========================================================
     *  ë“œë¡œì–´ ì—´ê¸°/ë‹«ê¸° ë° ê°’ ì±„ìš°ê¸°
     * ======================================================= */

    /**
     * ë“œë¡œì–´ ì—´ê¸° (id ì—†ìœ¼ë©´ ìƒˆ í•­ëª©ìœ¼ë¡œ ì—´ê¸°)
     */
    function openDrawer(id){
      const item = data.find(x => x.id === id);

      // í¸ì§‘ ì¤‘ì¸ í•­ëª© ì •ë³´ ì„¸íŒ…
      current = item || {
        id:   uid(),
        type: 'trait',
        name: '',
        icon: '',
        desc: '',
        tags: '',
        rank: '',
        mod:  {},
        modP: {}
      };

      $('#dwTitle').textContent = item ? 'í•­ëª© ìˆ˜ì •' : 'ìƒˆ í•­ëª©';

      // ê¸°ë³¸ í•„ë“œë“¤
      f.type.value = current.type;
      f.name.value = current.name;
      f.icon.value = current.icon;
      f.desc.value = current.desc;
      f.tags.value = current.tags || '';
      f.rank.value = current.rank || '';
      f.iconPrev.src = current.icon || '';

      // â˜… ëœë¤/ì¡°ê±´ í•„ë“œ ì±„ìš°ê¸°
      // undefined ì¸ ê¸°ì¡´ ë°ì´í„°ë„ ìì—°ìŠ¤ëŸ½ê²Œ ë™ì‘í•˜ë„ë¡ ê¸°ë³¸ê°’ ì²˜ë¦¬
      f.randomCandidate.checked = current.randomCandidate !== false; // ê¸°ë³¸ê°’: true
      f.condJobs.value  = Array.isArray(current.condJobs)
        ? current.condJobs.join(', ')
        : (current.condJobs || '');
      f.condRaces.value = Array.isArray(current.condRaces)
        ? current.condRaces.join(', ')
        : (current.condRaces || '');

      // ìŠ¤íƒ¯ ë³´ì • ê°’ (ê¸°ì¡´ í‚¤ í˜¸í™˜: atk/def/spd/hp â†’ str/end/agi/mana)
      const m = current.mod  || {};
      const p = current.modP || {};

      // ê³ ì •ê°’
      f.mStr.value  = m.str  ?? m.atk ?? 0;
      f.mEnd.value  = m.end  ?? m.def ?? 0;
      f.mAgi.value  = m.agi  ?? m.spd ?? 0;
      f.mInt.value  = m.int  ?? 0;
      f.mMana.value = m.mana ?? m.hp  ?? 0;
      f.mLuck.value = m.luck ?? 0;

      // ğŸ”¹ ì¶”ê°€: í„´ë‹¹ ë§ˆë‚˜ ì¬ìƒ (ê¸°ì¡´ ë°ì´í„°ì—” ì—†ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ê¸°ë³¸ 0)
      f.mMpRegen.value = current.mpRegen ?? 0;

      // % ë³´ì •
      f.mStrP.value  = p.str  ?? p.atk ?? 0;
      f.mEndP.value  = p.end  ?? p.def ?? 0;
      f.mAgiP.value  = p.agi  ?? p.spd ?? 0;
      f.mIntP.value  = p.int  ?? 0;
      f.mManaP.value = p.mana ?? p.hp  ?? 0;
      f.mLuckP.value = p.luck ?? 0;

      // ë“œë¡œì–´ í‘œì‹œ
      drawer.classList.add('show');

      // ì•„ì´ì½˜ íŒŒì¼ ì—…ë¡œë“œ â†’ base64 ë¡œ ë¯¸ë¦¬ë³´ê¸°/ì €ì¥
      if(f.iconFile){
        f.iconFile.onchange = e => {
          const file = e.target.files?.[0];
          if(!file) return;

          const r = new FileReader();
          r.onload = () => {
            f.icon.value     = r.result;
            f.iconPrev.src   = r.result;
          };
          r.readAsDataURL(file);
        };
      }

      // ì•„ì´ì½˜ URL ì§ì ‘ ì…ë ¥ ì‹œ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
      if(f.icon){
        f.icon.oninput = () => {
          f.iconPrev.src = f.icon.value;
        };
      }
    }

    // ë“œë¡œì–´ ë‹«ê¸°
    function closeDrawer(){
      drawer.classList.remove('show');
    }

    /* =========================================================
     *  ë“œë¡œì–´ â†’ data ë°˜ì˜ & ì €ì¥
     * ======================================================= */

    /**
     * í˜„ì¬ ë“œë¡œì–´ì˜ ë‚´ìš©ì„ data ë°°ì—´ì— ë°˜ì˜í•˜ê³  localStorage ì— ì €ì¥
     */
    async function persist(){
      const idx = data.findIndex(x => x.id === current.id);

    const entry = {
      id:   current.id,
      type: f.type.value,
      name: f.name.value.trim(),
      icon: f.icon.value.trim(),
      desc: f.desc.value.trim(),
      tags: f.tags.value.trim(),
      rank: f.rank.value,

      // â˜… ëœë¤/ì¡°ê±´ ì„¤ì • ì €ì¥
      randomCandidate: !!f.randomCandidate.checked,
      condJobs: (f.condJobs.value || '')
        .split(/\s*,\s*/)
        .map(s => s.trim())
        .filter(Boolean),
      condRaces: (f.condRaces.value || '')
        .split(/\s*,\s*/)
        .map(s => s.trim())
        .filter(Boolean),

      // ğŸ”¹ ì¶”ê°€: í„´ë‹¹ ë§ˆë‚˜ ì¬ìƒëŸ‰
      //   - ë„ê°ì—ì„œëŠ” ì´ ê°’ì„ íŠ¹ì„±/ìˆ™ë ¨ë„/ê¶ŒëŠ¥ ë“±ì˜ íŒ¨ì‹œë¸Œë¡œë§Œ ì‚¬ìš©
      mpRegen: +f.mMpRegen.value || 0,

      // ìƒˆ í‚¤ë¡œ ì €ì¥ (str/end/agi/int/mana/luck)
      mod: {
        str:  +f.mStr.value  || 0,
        end:  +f.mEnd.value  || 0,
        agi:  +f.mAgi.value  || 0,
        int:  +f.mInt.value  || 0,
        mana: +f.mMana.value || 0,
        luck: +f.mLuck.value || 0
      },
      modP: {
        str:  +f.mStrP.value  || 0,
        end:  +f.mEndP.value  || 0,
        agi:  +f.mAgiP.value  || 0,
        int:  +f.mIntP.value  || 0,
        mana: +f.mManaP.value || 0,
        luck: +f.mLuckP.value || 0
      }
    };

      // ê¸°ì¡´ í•­ëª©ì´ë©´ êµì²´, ì•„ë‹ˆë©´ ìƒˆë¡œ ì¶”ê°€
      if (idx >= 0) data[idx] = entry;
      else          data.push(entry);

      // ğŸ”’ ê´€ë¦¬ìë§Œ ì €ì¥ ê°€ëŠ¥
      if (!isAdmin) {
        alert('ê´€ë¦¬ìë§Œ ë„ê°ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }

      try {
        // ì„œë²„ì— ì „ì—­ ë„ê° ì €ì¥ (server.js ì—ì„œ /api/codex POST êµ¬í˜„í•´ë‘” ê²ƒ)
        await apiPost('/api/codex', { items: data });

        // localStorage ìºì‹œë„ ê°±ì‹ 
        save(data);

        // UI ê°±ì‹ 
        buildTagChips();
        render(currentFilter());
        closeDrawer();
      } catch (err) {
        console.error(err);
        alert('ë„ê° ì €ì¥ ì‹¤íŒ¨: ' + (err.error || err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    }

    /* =========================================================
     *  ì´ë²¤íŠ¸ ë°”ì¸ë”©
     * ======================================================= */

    // ì¢Œì¸¡ ì¢…ë¥˜ í•„í„° ë²„íŠ¼ë“¤
    document
      .querySelectorAll('.mbtn[data-filter]')
      .forEach(b => {
        b.onclick = () => {
          document
            .querySelectorAll('.mbtn[data-filter]')
            .forEach(x => x.classList.remove('active'));

          b.classList.add('active');
          render(b.dataset.filter);
        };
      });

    // ìƒˆ í•­ëª© ì¶”ê°€
    $('#addBtn').onclick = () => openDrawer(null);

    // ë“œë¡œì–´ ë‹«ê¸°/ì €ì¥
    $('#closeDw').onclick = closeDrawer;
    $('#saveDw').onclick  = persist;

    // ê²€ìƒ‰ì–´ ì…ë ¥ ì‹œ ì¦‰ì‹œ ë°˜ì˜
    q.oninput = () => render(currentFilter());

    // ì •ë ¬ / ë“±ê¸‰ í•„í„° ë³€ê²½
    sortSel.onchange = () => render(currentFilter());
    rankSel.onchange = () => render(currentFilter());

    // í•„í„° ì´ˆê¸°í™” ë²„íŠ¼
    clearBtn.onclick = () => {
      activeTags.clear();
      q.value = '';
      rankSel.value = '';
      buildTagChips();
      render('all');
    };

    // JSON ë‚´ë³´ë‚´ê¸°
    $('#exportBtn').onclick = () => {
      const blob = new Blob(
        [JSON.stringify(data, null, 2)],
        { type: 'application/json' }
      );
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'codex.json';
      a.click();
      URL.revokeObjectURL(a.href);
    };

    // JSON ë¶ˆëŸ¬ì˜¤ê¸° (ê´€ë¦¬ì ì „ìš© ì—…ë¡œë“œ)
    importInput.onchange = e => {
      const file = e.target.files?.[0];
      if (!file) return;

      const r = new FileReader();
      r.onload = async () => {
        try {
          const arr = JSON.parse(r.result);
          if (Array.isArray(arr)) {
            if (!isAdmin) {
              alert('ê´€ë¦¬ìë§Œ ë„ê° JSONì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              return;
            }

            data = arr;

            try {
              // ì„œë²„ì— ì „ì—­ ë„ê° ì €ì¥
              await apiPost('/api/codex', { items: data });

              // localStorage ìºì‹œ ê°±ì‹ 
              save(data);

              buildTagChips();
              render(currentFilter());
              alert('ë„ê° JSONì´ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (err) {
              console.error(err);
              alert('ë„ê° ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (err.error || err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
          }
        } catch {
          // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì¡°ìš©íˆ ë¬´ì‹œ
        }
      };
      r.readAsText(file);
    };

    /* =========================================================
    *  ì´ˆê¸° ë¡œë”© (ë¡œê·¸ì¸/ê¶Œí•œ + ì„œë²„ ë„ê° ë™ê¸°í™”) & ë Œë”ë§
    * ======================================================= */

    async function init() {
      // 1) ë‚´ ì •ë³´ì—ì„œ role í™•ì¸
      try {
        const me = await fetchMe();       // api.js ì— êµ¬í˜„ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
        currentUser = me.user || me;

        const rawRole = (currentUser.role || '').toString();
        const rawName = (currentUser.username || currentUser.name || '').toString();

        const roleLower = rawRole.toLowerCase();
        const nameLower = rawName.toLowerCase();

        // ì—¬ëŸ¬ í˜•íƒœë¥¼ ë‹¤ ë°›ì•„ì„œ admin íŒì •
        const flagAdmin = !!(currentUser.isAdmin || currentUser.admin);

        isAdmin =
          flagAdmin ||                 // isAdmin / admin í”Œë˜ê·¸
          roleLower === 'admin' ||     // role: 'admin'
          nameLower === 'admin';       // ê³„ì •ëª…ì´ admin ì¸ ê²½ìš°

        console.log('currentUser =', currentUser, 'isAdmin =', isAdmin);

        // ê´€ë¦¬ì ì „ìš© ë²„íŠ¼ ë¹„í™œì„±í™”
        if (!isAdmin) {
          document.querySelectorAll('.only-admin').forEach(el => {
            if (el.tagName === 'BUTTON' || el.tagName === 'INPUT') {
              el.disabled = true;
            }
            el.classList.add('disabled');
          });
        }
      } catch (e) {
        console.warn('ë‚´ ì •ë³´(fetchMe) ì‹¤íŒ¨', e);
      }

      // 2) ì„œë²„ì—ì„œ ë„ê° ë¡œë“œ (ì‹¤íŒ¨ ì‹œ localStorage ìºì‹œ ì‚¬ìš©)
      try {
        const arr = await apiGet('/api/codex');
        if (Array.isArray(arr)) {
          data = arr;
          save(data);   // ìºì‹œ ê°±ì‹ 
        } else {
          data = load();
        }
      } catch (e) {
        console.warn('ì„œë²„ ë„ê° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨, localStorage ì‚¬ìš©', e);
        data = load();
      }

      buildTagChips();
      render('all');
    }

    init();
  </script>
</body>
</html>