<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Battle â€“ í…ìŠ¤íŠ¸ ì „íˆ¬</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f0f12;--panel:#18181f;--panel2:#121219;
      --text:#e8e6e3;--muted:#b7b3ad;
      --gold:#d4af37;--gold2:#b8922b;--card:rgba(212,175,55,.35)
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(1000px 600px at 70% -10%,rgba(212,175,55,.12),transparent 70%),#050507;
      color:var(--text);
      font-family:'Noto Sans KR',system-ui,sans-serif;
    }
    a{color:inherit;text-decoration:none}

    header{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg,rgba(20,20,26,.9),rgba(20,20,26,.3));
      position:sticky;top:0;z-index:5;
    }
    .btn{
      padding:8px 12px;border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.04);
      cursor:pointer;color:var(--text);
      font-size:.9rem;
    }
    .btn.gold{
      background:linear-gradient(180deg,var(--gold),var(--gold2));
      color:#111;border:none;font-weight:700;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .wrap{
      display:grid;
      grid-template-columns:280px minmax(0,1fr) 280px;
      gap:14px;
      padding:14px;
    }
    .card{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:12px 14px;
      min-height:0;
    }
    .sideTitle{
      margin:0 0 8px;
      font-size:1rem;
      display:flex;justify-content:space-between;align-items:center;
    }

    select{
      width:100%;margin-bottom:8px;
      background:#11141a;color:var(--text);
      border:1px solid rgba(255,255,255,.14);
      border-radius:8px;padding:8px;
    }

    .charbox{
      display:flex;gap:10px;align-items:flex-start;
    }
    .charbox img{
      width:72px;height:96px;border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      object-fit:cover;background:#111;
    }
    .char-meta{font-size:.85rem}
    .char-meta strong{font-size:.95rem}
    .small{font-size:.8rem;color:var(--muted)}

    .statRow{
      display:flex;justify-content:space-between;align-items:center;
      font-size:.8rem;margin-top:2px;
    }
    .bar{
      flex:1;margin:0 6px;
      height:8px;border-radius:99px;
      background:#0d0f14;border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .bar span{
      display:block;height:100%;
      background:linear-gradient(90deg,var(--gold),var(--gold2));
      width:0%;
    }

    /* CENTER â€“ battle */
    .mainTitle{
      margin:0 0 8px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .hpRow{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:6px;
      font-size:.8rem;
      margin-bottom:8px;
    }
    .hpBox{
      padding:6px 8px;
      background:#101018;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.1);
    }
    .hpBox strong{font-size:.9rem}
    .hpBar{
      margin-top:4px;
      height:10px;border-radius:99px;
      background:#1a1a22;border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
    }
    .hpBar span{
      display:block;height:100%;
      background:linear-gradient(90deg,#e53935,#d4af37);
      width:100%;
    }

    .log{
      margin-top:6px;
      border-radius:10px;
      background:#101019;
      border:1px solid rgba(255,255,255,.12);
      padding:8px;
      font-size:.85rem;
      height:260px;
      overflow:auto;
      line-height:1.4;
      white-space:pre-line;
    }
    .turnTag{
      color:var(--gold);font-weight:700;
    }

    .controls{
      display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;
    }

    @media(max-width:1000px){
      .wrap{
        grid-template-columns:1fr;
        grid-template-rows:auto auto auto;
      }
    }
  </style>
</head>
<body>
  <header>
    <strong style="font-family:'Cinzel',serif;letter-spacing:.06em">BATTLE</strong>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn" href="index.html">â† ë©”ì¸</a>
      <a class="btn" href="member.html">ë©¤ë²„</a>
      <a class="btn" href="character.html">í”„ë¡œí•„</a>
      <a class="btn" href="compendium.html">ë„ê°</a>
    </div>
  </header>

  <div class="wrap">
    <!-- LEFT: Player -->
    <section class="card">
      <h3 class="sideTitle">ì•„êµ°<span class="small">ì¢Œì¸¡ ìºë¦­í„°</span></h3>
      <select id="leftSel"></select>
      <div id="leftInfo" class="charbox">
        <img alt="left portrait">
        <div class="char-meta small">ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
    </section>

    <!-- CENTER: Battle -->
    <section class="card">
      <div class="mainTitle">
        <h3 style="margin:0">í…ìŠ¤íŠ¸ ì „íˆ¬</h3>
        <span id="turnInfo" class="small">ì „íˆ¬ ì¤€ë¹„ ì¤‘â€¦</span>
      </div>

      <div class="hpRow">
        <div class="hpBox">
          <div><strong id="lName">-</strong> <span class="small">(ì•„êµ°)</span></div>
          <div class="small">HP <span id="lHpText">0 / 0</span> Â· MP <span id="lMpText">0 / 0</span></div>
          <div class="hpBar"><span id="lHpBar"></span></div>
        </div>
        <div class="hpBox">
          <div><strong id="rName">-</strong> <span class="small">(ì )</span></div>
          <div class="small">HP <span id="rHpText">0 / 0</span> Â· MP <span id="rMpText">0 / 0</span></div>
          <div class="hpBar"><span id="rHpBar"></span></div>
        </div>
      </div>

      <div class="log" id="log">
[ì•ˆë‚´] ì¢Œ/ìš° ìºë¦­í„°ë¥¼ ì„ íƒí•˜ê³  "ì „íˆ¬ ì‹œì‘"ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      </div>

      <div class="controls">
        <button id="startBtn" class="btn gold">ì „íˆ¬ ì‹œì‘ / ë¦¬ì…‹</button>
        <button id="stepBtn" class="btn" disabled>í•œ í„´ ì§„í–‰</button>
        <button id="autoBtn" class="btn" disabled>ìë™ ì „íˆ¬</button>
      </div>
    </section>

    <!-- RIGHT: Enemy -->
    <section class="card">
      <h3 class="sideTitle">ì êµ°<span class="small">ìš°ì¸¡ ìºë¦­í„°</span></h3>
      <select id="rightSel"></select>
      <div id="rightInfo" class="charbox">
        <img alt="right portrait">
        <div class="char-meta small">ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
    </section>
  </div>

  <script>
  // ===== ê³µí†µ ìŠ¤í† ë¦¬ì§€ í‚¤ =====
  const STORE = 'members.v1';
  const CODEX = 'codex.v1';

  const $ = s => document.querySelector(s);

  // ì„œë²„ + localStorage â†’ ë©¤ë²„ ëª©ë¡ ë¡œë”©
  async function loadMembers() {
    // 1) ë¨¼ì € ì„œë²„ì—ì„œ ì‹œë„ (ë¡œê·¸ì¸ í† í° ê¸°ë°˜ â†’ ë‚´ ê³„ì • ìºë¦­í„°ë§Œ)
    try {
      const serverList = await apiGet('/api/members');

      if (Array.isArray(serverList) && serverList.length > 0) {
        // ì„œë²„ì— ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì§„ì‹¤ë¡œ ì‚¬ìš©
        return serverList;
      }
    } catch (e) {
      console.error('ì„œë²„ì—ì„œ ë©¤ë²„ ë¡œë“œ ì‹¤íŒ¨', e);
    }

    // 2) ì„œë²„ê°€ ë¹„ì–´ ìˆê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš° â†’ localStorage ì‚¬ìš© (ì˜› ë°ì´í„° ë°±ì—…)
    try {
      const a = localStorage.getItem(STORE);
      const b = localStorage.getItem('memberData.v1'); // êµ¬ë²„ì „ í˜¸í™˜
      const parsed = a ? JSON.parse(a) : (b ? JSON.parse(b) : []);
      return Array.isArray(parsed) ? parsed : [];
    } catch (e) {
      console.error(e);
      return [];
    }
  }

  // ë„ê° ë¡œë”© (íŠ¹ì„±/ìˆ™ë ¨ë„/ê¶ŒëŠ¥ ë³´ì •ìš©)
  function loadCodex() {
    try {
      return JSON.parse(localStorage.getItem(CODEX) || '[]');
    } catch {
      return [];
    }
  }

  // === ë„ê° íŠ¹ì„± ë³´ì •: character.htmlê³¼ ë™ì¼í•œ ê·œì¹™ê³¼ ì¼ê´€ì„± ìœ ì§€ìš© ===
  const RANK_ORDER = [
    "EX","SSS","SS","S+","S",
    "A++","A+","A","A-",
    "B++","B+","B","B-",
    "C++","C+","C","C-",
    "D++","D+","D","D-",
    "F++","F+","F","F-"
  ];
  const rankIndex = r => {
    const i = RANK_ORDER.indexOf(r || '');
    return i < 0 ? 999 : i;
  };

  // í•­ìƒ ìŠ¤íƒ¯ì— ë°˜ì˜ë˜ëŠ” íŠ¹ì„± íƒ€ì…
  function collectSkillMods(ch) {
    const ALWAYS_ON_TYPES = new Set(['trait','proficiency','authority']); // íŠ¹ì„± / ìˆ™ë ¨ë„ / ê¶ŒëŠ¥
    const names = ch.skills || [];
    const codex = loadCodex();

    // ìŠ¤í‚¬ ë°°ì—´ì´ ë¬¸ìì—´/ê°ì²´ ì„ì—¬ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì´ë¦„ë§Œ ë½‘ì•„ì„œ Set ìƒì„±
    const set = new Set((names || []).map(s => {
      if (!s) return '';
      if (typeof s === 'string') return s.toLowerCase();
      return (s.name || '').toLowerCase();
    }));

    const flat = { str:0, end:0, agi:0, int:0, mana:0, luck:0 };
    const pct  = { str:0, end:0, agi:0, int:0, mana:0, luck:0 };

    codex.forEach(e => {
      if (!ALWAYS_ON_TYPES.has(e.type)) return;
      if (!set.has((e.name || '').toLowerCase())) return;

      const m = e.mod  || {};
      const p = e.modP || {};

      flat.str  += +(m.str  ?? m.atk  ?? 0);
      flat.end  += +(m.end  ?? m.def  ?? 0);
      flat.agi  += +(m.agi  ?? m.spd  ?? 0);
      flat.int  += +(m.int  ?? 0);
      flat.mana += +(m.mana ?? m.hp   ?? 0);
      flat.luck += +(m.luck ?? 0);

      pct.str   += +(p.str  ?? p.atk  ?? 0);
      pct.end   += +(p.end  ?? p.def  ?? 0);
      pct.agi   += +(p.agi  ?? p.spd  ?? 0);
      pct.int   += +(p.int  ?? 0);
      pct.mana  += +(p.mana ?? p.hp   ?? 0);
      pct.luck  += +(p.luck ?? 0);
    });

    return { flat, pct };
  }

  // ì „íˆ¬ ì‹œì—ë§Œ ì“°ëŠ” ì¢…ë¥˜ (ê¸°ìˆ /ë§ˆë²•/ìŠ¤í‚¬)
  const BATTLE_ONLY_TYPES = new Set(['tech','magic','skill']);

  // ì´ë²ˆ ê³µê²©ì— ì‚¬ìš©í•  ì „íˆ¬ ìŠ¤í‚¬ 1ê°œ ì„ íƒ
  function pickBattleSkill(att, kind) {
    const names = att.ch.skills || [];
    if (!names.length) return null;

    const codex = loadCodex();
    const lowerNames = names.map(n => {
      if (!n) return '';
      if (typeof n === 'string') return n.toLowerCase();
      return (n.name || '').toLowerCase();
    });

    const candidates = codex.filter(e => {
      if (!BATTLE_ONLY_TYPES.has(e.type)) return false;
      if (!lowerNames.includes((e.name || '').toLowerCase())) return false;
      // kind(physical/magic)ì— ë”°ë¼ í•„í„°ë¥¼ ë” ë„£ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬
      return true;
    });

    if (!candidates.length) return null;
    const chosen = candidates[randInt(0, candidates.length - 1)];

    const m = chosen.mod  || {};
    const p = chosen.modP || {};

    const flat = {
      str:  +(m.str  ?? m.atk  ?? 0),
      int:  +(m.int  ?? 0),
      luck: +(m.luck ?? 0),
    };
    const pct  = {
      str:  +(p.str  ?? p.atk  ?? 0),
      int:  +(p.int  ?? 0),
      luck: +(p.luck ?? 0),
    };

    return { entry: chosen, flat, pct };
  }

  // ì „íˆ¬ì— í•­ìƒ ì˜í–¥ì„ ì£¼ëŠ” íŒ¨ì‹œë¸Œ íŠ¹ì„± íƒ€ì…
  // (ë„ê°ì—ì„œ typeì´ 'trait', 'proficiency', 'authority' ì¸ ê²ƒë“¤)
  const ALWAYS_ON_TYPES = new Set(['trait', 'proficiency', 'authority']);

  function collectSkillMods(ch) {
    const flat = { str:0, end:0, agi:0, int:0, mana:0, luck:0 };
    const pct  = { str:0, end:0, agi:0, int:0, mana:0, luck:0 };
    let mpRegen = 0;  // ğŸ”¹ ì¶”ê°€: í„´ë‹¹ ë§ˆë‚˜ ì¬ìƒ í•©ì‚°ìš©

    const owned = new Set((ch.skills || []).map(s => s.id || s.name).filter(Boolean));
    const codex = loadCodex();

    codex.forEach(e => {
      if(!ALWAYS_ON_TYPES.has(e.type)) return;
      if(!owned.has(e.id) && !owned.has(e.name)) return;

      const m = e.mod  || {};
      const p = e.modP || {};

      // ê³ ì •ê°’
      flat.str  += +(m.str  ?? m.atk ?? 0);
      flat.end  += +(m.end  ?? m.def ?? 0);
      flat.agi  += +(m.agi  ?? m.spd ?? 0);
      flat.int  += +(m.int  ?? 0);
      flat.mana += +(m.mana ?? m.hp  ?? 0);
      flat.luck += +(m.luck ?? 0);

      // % ë³´ì •
      pct.str   += +(p.str  ?? p.atk ?? 0);
      pct.end   += +(p.end  ?? p.def ?? 0);
      pct.agi   += +(p.agi  ?? p.spd ?? 0);
      pct.int   += +(p.int  ?? 0);
      pct.mana  += +(p.mana ?? p.hp   ?? 0);
      pct.luck  += +(p.luck ?? 0);

      // ğŸ”¹ ì¶”ê°€: ì´ íŠ¹ì„±ì´ ê°–ê³  ìˆëŠ” í„´ë‹¹ ë§ˆë‚˜ ì¬ìƒëŸ‰
      if (typeof e.mpRegen === 'number') {
        mpRegen += e.mpRegen;
      }
    });

    return { flat, pct, mpRegen };
  }

// ìµœì¢… ì „íˆ¬ ìŠ¤íƒ¯ ê³„ì‚° (ê¸°ë³¸ ìŠ¤íƒ¯ + íŠ¹ì„± ë³´ì •)
function calcFinalStats(ch) {
  const base = ch.stats || {};
  const mods = collectSkillMods(ch);
  const out = {};

  ["str","end","agi","int","mana","luck"].forEach(k => {
    const b     = base[k] || 0;
    const dFlat = mods.flat[k] || 0;
    const dPct  = mods.pct[k]  || 0;
    out[k] = b + dFlat + Math.round(b * (dPct / 100));
  });

  // íŒŒìƒ ìŠ¤íƒ¯
  out.maxHp = 50 + out.end * 10;
  out.maxMp = 10 + out.mana * 5;
  out.atk   = out.str;
  out.mag   = out.int;
  out.spd   = out.agi;
  out.luk   = out.luck;
  return out;
}


  // ===== ì „ì—­ ìƒíƒœ =====
  const state = {
    members: [],
    leftId:  null,
    rightId: null,
    battle:  null
  };

  // ===== UI ë Œë”ë§ =====
  function fillSelects() {
    const leftSel  = $('#leftSel');
    const rightSel = $('#rightSel');
    leftSel.innerHTML  = '';
    rightSel.innerHTML = '';

    if (!state.members.length) {
      leftSel.innerHTML  = '<option>ìºë¦­í„° ì—†ìŒ</option>';
      rightSel.innerHTML = '<option>ìºë¦­í„° ì—†ìŒ</option>';
      return;
    }

    state.members.forEach((ch, idx) => {
      const opt1 = document.createElement('option');
      opt1.value       = ch.id;
      opt1.textContent = ch.name || `ìºë¦­í„° ${idx+1}`;
      leftSel.appendChild(opt1);

      const opt2 = document.createElement('option');
      opt2.value       = ch.id;
      opt2.textContent = ch.name || `ìºë¦­í„° ${idx+1}`;
      rightSel.appendChild(opt2);
    });

    // ê¸°ë³¸ê°’: ì²« ë²ˆì§¸ / ë‘ ë²ˆì§¸
    state.leftId  = state.members[0]?.id || null;
    state.rightId = state.members[1]?.id || state.members[0]?.id || null;

    if (state.leftId)  leftSel.value  = state.leftId;
    if (state.rightId) rightSel.value = state.rightId;

    updateSideInfo('left');
    updateSideInfo('right');
  }

  function updateSideInfo(side) {
    const isLeft = side === 'left';
    const id     = isLeft ? state.leftId : state.rightId;
    const info   = isLeft ? $('#leftInfo') : $('#rightInfo');
    const ch     = state.members.find(c => c.id === id);

    info.innerHTML = '';
    const img  = document.createElement('img');
    const meta = document.createElement('div');
    meta.className = 'char-meta';

    if (!ch) {
      img.alt = '';
      meta.innerHTML = '<div class="small">ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    } else {
      img.src = ch.img || 'https://via.placeholder.com/120x160/1d1f26/777?text=NO+IMAGE';
      img.alt = ch.name || 'portrait';
      const st = calcFinalStats(ch);
      meta.innerHTML = `
        <strong>${ch.name || 'ë¬´ëª…'}</strong>
        <div class="small">${ch.role || '-'} / ${ch.sub || ''}</div>
        <div class="statRow">
          <span class="small">ê·¼ë ¥</span>
          <div class="bar"><span style="width:${Math.min(100, st.str)}%"></span></div>
          <span class="small">${st.str}</span>
        </div>
        <div class="statRow">
          <span class="small">ë‚´êµ¬</span>
          <div class="bar"><span style="width:${Math.min(100, st.end)}%"></span></div>
          <span class="small">${st.end}</span>
        </div>
        <div class="statRow">
          <span class="small">ë¯¼ì²©</span>
          <div class="bar"><span style="width:${Math.min(100, st.agi)}%"></span></div>
          <span class="small">${st.agi}</span>
        </div>
        <div class="statRow">
          <span class="small">ì§€ë ¥</span>
          <div class="bar"><span style="width:${Math.min(100, st.int)}%"></span></div>
          <span class="small">${st.int}</span>
        </div>
        <div class="statRow">
          <span class="small">ë§ˆë‚˜</span>
          <div class="bar"><span style="width:${Math.min(100, st.mana)}%"></span></div>
          <span class="small">${st.mana}</span>
        </div>
        <div class="statRow">
          <span class="small">í–‰ìš´</span>
          <div class="bar"><span style="width:${Math.min(100, st.luck)}%"></span></div>
          <span class="small">${st.luck}</span>
        </div>
      `;
    }
    info.appendChild(img);
    info.appendChild(meta);
  }

  // ===== ì „íˆ¬ ìƒíƒœ ìƒì„± =====
  function makeFighter(ch) {
  const s    = calcFinalStats(ch);
  const mods = collectSkillMods(ch);  // ğŸ”¹ íŒ¨ì‹œë¸Œ íŠ¹ì„±ì—ì„œ mpRegen ê°€ì ¸ì˜¤ê¸°

  return {
    ch,          // ì›ë³¸ ìºë¦­í„° ì •ë³´
    stats: s,    // ìµœì¢… ìŠ¤íƒ¯
    hp: s.maxHp, // í˜„ì¬ HP
    mp: s.maxMp, // í˜„ì¬ MP

    // ğŸ”¹ í„´ë‹¹ ë§ˆë‚˜ ì¬ìƒëŸ‰ (íŠ¹ì„±/ìˆ™ë ¨ë„/ê¶ŒëŠ¥ì—ì„œ ì˜¨ í•©ì‚°ê°’)
    mpRegen: mods.mpRegen || 0
  };
}

  function resetBattle() {
    const leftCh  = state.members.find(c => c.id === state.leftId);
    const rightCh = state.members.find(c => c.id === state.rightId);
    const log     = $('#log');

    if (!leftCh || !rightCh) {
      log.textContent = '[ì—ëŸ¬] ì–‘ìª½ ëª¨ë‘ ìºë¦­í„°ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.';
      return;
    }

    state.battle = {
      turn: 1,
      left: makeFighter(leftCh),
      right: makeFighter(rightCh),
      finished: false
    };

    $('#lName').textContent = leftCh.name  || 'ë¬´ëª…';
    $('#rName').textContent = rightCh.name || 'ë¬´ëª…';

    updateHpUi();
    log.textContent =
      `ì „íˆ¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n` +
      `ì•„êµ°: ${leftCh.name  || 'ë¬´ëª…'}\n` +
      `ì êµ°: ${rightCh.name || 'ë¬´ëª…'}\n\n` +
      `[ì „íˆ¬ ê·œì¹™]\n- ë¯¼ì²©ì´ ë†’ì€ ìª½ì´ ë¨¼ì € í–‰ë™í•©ë‹ˆë‹¤.\n- ê·¼ë ¥/ì§€ë ¥ì„ ê¸°ì¤€ìœ¼ë¡œ ë¬¼ë¦¬/ë§ˆë²• ê³µê²©ì„ ì„ íƒí•©ë‹ˆë‹¤.\n- í–‰ìš´ì€ ëª…ì¤‘ë¥ , í¬ë¦¬í‹°ì»¬ í™•ë¥ ì— ì˜í–¥ì„ ì¤ë‹ˆë‹¤.\n`;

    $('#turnInfo').textContent = '1í„´ ì‹œì‘';
    $('#stepBtn').disabled = false;
    $('#autoBtn').disabled = false;
  }

  function updateHpUi() {
    const b = state.battle;
    if (!b) return;

    const lHpPct = Math.max(0, Math.min(100, (b.left.hp  / b.left.stats.maxHp  * 100)));
    const rHpPct = Math.max(0, Math.min(100, (b.right.hp / b.right.stats.maxHp * 100)));

    $('#lHpText').textContent = `${Math.max(0, b.left.hp)}  / ${b.left.stats.maxHp}`;
    $('#rHpText').textContent = `${Math.max(0, b.right.hp)} / ${b.right.stats.maxHp}`;
    $('#lMpText').textContent = `${Math.max(0, b.left.mp)}  / ${b.left.stats.maxMp}`;
    $('#rMpText').textContent = `${Math.max(0, b.right.mp)} / ${b.right.stats.maxMp}`;
    $('#lHpBar').style.width = `${lHpPct}%`;
    $('#rHpBar').style.width = `${rHpPct}%`;
  }

  function appendLog(text) {
    const log = $('#log');
    log.textContent += '\n' + text;
    log.scrollTop = log.scrollHeight;
  }

  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function calcHitChance(att, def) {
    // ê¸°ë³¸ 80% + ë¯¼ì²© ì°¨ì´ + í–‰ìš´ ë³´ì •
    let base = 80 + (att.stats.spd - def.stats.spd) * 0.5 + (att.stats.luk - def.stats.luk) * 0.3;
    return Math.max(10, Math.min(98, base));
  }

  function calcCritChance(att) {
    // ê¸°ë³¸ 10% + í–‰ìš´ * 0.5
    return Math.max(0, Math.min(80, 10 + att.stats.luk * 0.5));
  }

  function doAttack(att, def) {
    // ê³µê²© ë°©ì‹ ê²°ì •: ì§€ë ¥ì´ ë” ë†’ê³  MPê°€ ì¶©ë¶„í•˜ë©´ ë§ˆë²•, ì•„ë‹ˆë©´ ë¬¼ë¦¬
    const useMagic = att.stats.mag > att.stats.atk && att.mp >= 10;
    const kind     = useMagic ? 'magic' : 'physical';

    // ì´ë²ˆ ê³µê²©ì— ì“¸ ì „íˆ¬ìš© ìŠ¤í‚¬ 1ê°œ (ê¸°ìˆ /ë§ˆë²•/ìŠ¤í‚¬)
    const battleSkill = pickBattleSkill(att, kind);

    const hitChance = calcHitChance(att, def);
    const rollHit   = Math.random() * 100;
    if (rollHit > hitChance) {
      return `${att.ch.name || 'ë¬´ëª…'}ì˜ ê³µê²©! ê·¸ëŸ¬ë‚˜ ë¹—ë‚˜ê°”ë‹¤â€¦ (ëª…ì¤‘ë¥  ${hitChance.toFixed(1)}%)`;
    }

    const critChance = calcCritChance(att);
    const isCrit     = (Math.random() * 100) < critChance;

    // --- ê³µê²©ë ¥ ê³„ì‚°: ê¸°ë³¸ ìŠ¤íƒ¯ + (í•´ë‹¹ ìŠ¤í‚¬ì˜ ë³´ì •) ---
    let atkBase  = useMagic ? att.stats.mag : att.stats.atk;
    let atkFinal = atkBase;

    if (battleSkill) {
      const { flat, pct } = battleSkill;
      if (useMagic) {
        const f = flat.int || 0;
        const p = pct.int  || 0;
        atkFinal = atkBase + f + Math.round(atkBase * (p / 100));
      } else {
        const f = flat.str || 0;
        const p = pct.str  || 0;
        atkFinal = atkBase + f + Math.round(atkBase * (p / 100));
      }
    }

    let dmgBase;
    if (kind === 'magic') {
      // ë§ˆë²• í”¼í•´: ì§€ë ¥ ê¸°ë°˜, ìƒëŒ€ ì§€ë ¥ìœ¼ë¡œ ì•½ê°„ ê°ì†Œ
      dmgBase = atkFinal * 1.2 - def.stats.int * 0.3;
      att.mp = Math.max(0, att.mp - 10); // ë§ˆë²•ì€ MP 10 ì†Œëª¨
    } else {
      // ë¬¼ë¦¬ í”¼í•´: ê·¼ë ¥ ê¸°ë°˜, ìƒëŒ€ ë‚´êµ¬ë¡œ ê°ì†Œ
      dmgBase = atkFinal * 1.1 - def.stats.end * 0.4;
    }
    if (dmgBase < 1) dmgBase = 1;

    if (isCrit) {
      dmgBase *= 1.5;
    }

    const variance = 0.85 + Math.random() * 0.3; // Â±15%
    const finalDmg = Math.max(1, Math.round(dmgBase * variance));
    def.hp = Math.max(0, def.hp - finalDmg);

    // ë¡œê·¸ì— ì°í ì´ë¦„
    // - ì „íˆ¬ìš© ìŠ¤í‚¬(battleSkill)ì´ ìˆìœ¼ë©´: ê·¸ ì´ë¦„ ì‚¬ìš© (tech / magic / skill ë§Œ)
    // - ì—†ìœ¼ë©´: ê·¸ëƒ¥ "ê³µê²©" / "ë§ˆë²• ê³µê²©" ê°™ì€ ì¼ë°˜ ì´ë¦„ë§Œ ì‚¬ìš©
    let skillName;
    if (battleSkill && battleSkill.entry && battleSkill.entry.name) {
      skillName = battleSkill.entry.name;
    } else {
      skillName = useMagic ? 'ë§ˆë²• ê³µê²©' : 'ê³µê²©';
    }

    let line = `${att.ch.name || 'ë¬´ëª…'}ê°€ ${skillName}ì„(ë¥¼) ì‚¬ìš©í–ˆë‹¤! ${finalDmg} í”¼í•´.`;
    line += isCrit ? ` (ì¹˜ëª…íƒ€! í™•ë¥  ${critChance.toFixed(1)}%)` : '';
    return line;
  }

  function endBattle() {
    const b = state.battle;
    if (!b || b.finished) return;
    b.finished = true;
    $('#stepBtn').disabled = true;
    $('#autoBtn').disabled = true;

    const lh = b.left.hp;
    const rh = b.right.hp;
    if (lh > 0 && rh <= 0) {
      appendLog('\nâ˜… ì•„êµ° ìŠ¹ë¦¬!');
    } else if (rh > 0 && lh <= 0) {
      appendLog('\nâ˜… ì êµ° ìŠ¹ë¦¬!');
    } else {
      appendLog('\nâ˜… ì–‘ìª½ ëª¨ë‘ ì“°ëŸ¬ì¡Œë‹¤. ë¬´ìŠ¹ë¶€!');
    }
  }

  // ğŸ”¹ í„´ ì‹œì‘ ì‹œ ë§ˆë‚˜ ì¬ìƒ ì²˜ë¦¬
function applyManaRegenForTurn(b) {
  if (!b) return;

  [b.left, b.right].forEach(f => {
    if (!f || !f.stats) return;

    const regen = f.mpRegen || 0;
    if (!regen || regen <= 0) return;

    // ğŸ”¹ ì‹ ì„±ë ¥ ìì›(holy)ì€ ì¬ìƒ ê¸ˆì§€
    //   - ë‚˜ì¤‘ì— ìºë¦­í„° ì €ì¥ ì‹œ ch.resourceType = 'holy' ê°™ì´ ì„¸íŒ…í•´ ë‘ë©´ ë¨
    const resourceType =
      (f.ch && f.ch.resourceType) ||
      (f.ch && f.ch.resource) ||
      'mana';

    if (resourceType === 'holy') {
      return; // ì‹ ì„±ë ¥ì€ ì¬ìƒ ì•ˆ í•¨
    }

    const maxMp = f.stats.maxMp || 0;
    if (maxMp <= 0) return;

    const before = f.mp;
    const after  = Math.min(maxMp, before + regen);
    if (after <= before) return;

    f.mp = after;
    appendLog(
      `${f.ch.name || 'ë¬´ëª…'}ì˜ ë§ˆë‚˜ê°€ ${regen} íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤. ` +
      `(${before} â†’ ${after})`
    );
  });
}

  function stepTurn() {
    const b = state.battle;
    if (!b || b.finished) return;

    const left  = b.left;
    const right = b.right;

    // ì´ë¯¸ í•œìª½ì´ ì“°ëŸ¬ì¡Œë‹¤ë©´ ì¢…ë£Œ
    if (left.hp <= 0 || right.hp <= 0) {
      endBattle();
      return;
    }

    appendLog('\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
    appendLog(`[í„´ ${b.turn}]`);

    // ğŸ”¹ í„´ ì‹œì‘ ì‹œ ë§ˆë‚˜ ì¬ìƒ ì²˜ë¦¬ (ë§ˆë‚˜ë§Œ, ì‹ ì„±ë ¥ì€ ì œì™¸)
    applyManaRegenForTurn(b);
    updateHpUi(); // MP ë°” ê°±ì‹ 

    // í„´ ìˆœì„œ: ë¯¼ì²© + ì•½ê°„ì˜ ëœë¤
    const leftInit  = left.stats.spd  + randInt(0, 5);
    const rightInit = right.stats.spd + randInt(0, 5);

    const first  = leftInit >= rightInit ? left  : right;
    const second = leftInit >= rightInit ? right : left;

    const firstName  = first.ch.name  || 'ë¬´ëª…';
    const secondName = second.ch.name || 'ë¬´ëª…';

    appendLog(`ì„ ì œê¶Œ: ${leftInit >= rightInit ? 'ì•„êµ°' : 'ì êµ°'} (${leftInit} vs ${rightInit})`);

    // 1ë²ˆì§¸ í–‰ë™
    appendLog(doAttack(first, second));
    updateHpUi();
    if (second.hp <= 0) {
      appendLog(`${secondName}ì€(ëŠ”) ì“°ëŸ¬ì¡Œë‹¤!`);
      endBattle();
      b.turn++;
      $('#turnInfo').textContent = `${b.turn - 1}í„´ ì¢…ë£Œ (ì „íˆ¬ ì¢…ë£Œ)`;
      return;
    }

    // 2ë²ˆì§¸ í–‰ë™
    appendLog(doAttack(second, first));
    updateHpUi();
    if (first.hp <= 0) {
      appendLog(`${firstName}ì€(ëŠ”) ì“°ëŸ¬ì¡Œë‹¤!`);
      endBattle();
      b.turn++;
      $('#turnInfo').textContent = `${b.turn - 1}í„´ ì¢…ë£Œ (ì „íˆ¬ ì¢…ë£Œ)`;
      return;
    }

    b.turn++;
    $('#turnInfo').textContent = `${b.turn}í„´ ì¤€ë¹„`;
  }

  function autoBattle() {
    const b = state.battle;
    if (!b) return;
    let safety = 50; // ìµœëŒ€ í„´ ìˆ˜ ì œí•œ
    while (!b.finished && safety-- > 0) {
      stepTurn();
    }
  }

  // ===== ì´ˆê¸°í™” =====
  async function init() {
    // ì„œë²„ + ë¡œì»¬ì—ì„œ ë©¤ë²„ ëª©ë¡ ë¡œë”©
    state.members = await loadMembers();

    if (!state.members.length) {
      $('#log').textContent =
        '[ì•ˆë‚´] ì €ì¥ëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\nmember.htmlì—ì„œ ìºë¦­í„°ë¥¼ ë¨¼ì € ìƒì„±í•´ ì£¼ì„¸ìš”.';
      $('#startBtn').disabled = true; // â† ì˜¤íƒ€ ì£¼ì˜: disable ê°€ ì•„ë‹ˆë¼ disabled
      return;
    }

    fillSelects();

    $('#leftSel').addEventListener('change', e => {
      state.leftId = e.target.value;
      updateSideInfo('left');
    });
    $('#rightSel').addEventListener('change', e => {
      state.rightId = e.target.value;
      updateSideInfo('right');
    });

    $('#startBtn').addEventListener('click', () => {
      resetBattle();
    });
    $('#stepBtn').addEventListener('click', () => {
      stepTurn();
    });
    $('#autoBtn').addEventListener('click', () => {
      autoBattle();
    });
  }

  init();
</script>
</body>
</html>