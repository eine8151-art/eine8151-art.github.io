<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>member â€“ ìºë¦­í„° ê´€ë¦¬ + ë„ê° ì—°ë™ (í”½ì„œ)</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  :root{--bg:#0f0f12;
    --panel:#18181f;
    --panel2:#121219;
    --text:#e8e6e3;
    --muted:#b7b3ad;
    --gold:#d4af37;
    --gold2:#b8922b;
    --card:rgba(212,175,55,.35)
  }
  
  *{
    box-sizing:border-box
  } body{
    margin:0;
    background:radial-gradient(1200px 800px at 65% -10%, rgba(212,175,55,.1), transparent 70%),var(--bg);
    color:var(--text);
    font-family:'Noto Sans KR',sans-serif
  }
  
  .header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:14px 16px;
    border-bottom:1px solid rgba(255,255,255,.08)
  }
  
  .btn{
    background:linear-gradient(180deg,var(--gold),var(--gold2));
    color:#111;
    border:none;
    border-radius:10px;
    padding:10px 14px;
    font-weight:800;
    cursor:pointer
  }
  
  .btn.outline{
    background:transparent;
    color:var(--text);
    border:1px solid rgba(212,175,55,.4)
  }
  
  .wrap{
    display:grid;
    grid-template-columns:360px 1fr;
    gap:16px;
    padding:16px
  }
  
  .card{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border:1px solid rgba(255,255,255,.08);
    border-radius:14px;
    padding:14px
  }
  
  .list{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
    gap:10px
  }
  
  .item{
    border:1px solid var(--card);
    border-radius:10px;
    overflow:hidden;
    background:#1e1e26;
    cursor:pointer;
    transition:.2s
  }
  
  .item:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 20px rgba(0,0,0,.35)
  }
  
  .item img{
    width:100%;
    height:160px;
    object-fit:cover
  }
  
  .item .t{
    padding:8px;
    text-align:center
  }
  
  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
    margin-bottom:10px
  }
  
  input,select,textarea{
    background:#11141a;
    color:var(--text);
    border:1px solid rgba(255,255,255,.12);
    border-radius:8px;
    padding:10px
  }
  
  .grid2{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px
  }
.pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(212,175,55,.35);margin:4px 6px 0 0}
.pill button{background:none;border:none;color:var(--muted);cursor:pointer}
hr{border:none;border-top:1px dashed rgba(255,255,255,.12);margin:12px 0}
.preview{display:flex;gap:12px;align-items:flex-start}
.preview img{width:160px;height:200px;border-radius:10px;border:1px solid var(--card);object-fit:cover}
.small{font-size:.85rem;color:var(--muted)}

/* === Mini Codex Picker === */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
.modal.show{display:flex}
.sheet{width:min(980px,100%);height:min(80vh,760px);display:grid;grid-template-columns:280px 1fr;background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid rgba(255,255,255,.12);border-radius:14px;overflow:hidden}
.sleft{border-right:1px solid rgba(255,255,255,.08);padding:12px;display:flex;flex-direction:column;gap:8px}
.sright{padding:12px;display:grid;grid-template-rows:auto 1fr auto;gap:8px}
.srch{display:flex;gap:8px;flex-wrap:wrap}
.tags{display:flex;flex-wrap:wrap;gap:8px}
.tag{padding:6px 10px;border:1px solid rgba(255,255,255,.18);border-radius:999px;background:rgba(255,255,255,.04);cursor:pointer;font-size:.9rem}
.tag.active{background:rgba(212,175,55,.15);border-color:var(--card)}
.listc{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;overflow:auto}
.cardc{border:1px solid var(--card);border-radius:10px;overflow:hidden;background:#1d1e25;cursor:pointer;transition:.15s}
.cardc:hover{transform:translateY(-2px)}
.cardc.selected{outline:2px solid var(--gold);box-shadow:0 0 0 3px rgba(212,175,55,.25) inset}
.thc{height:110px;background:#2a2b33 center/cover no-repeat}
.meta{padding:8px}
.badge{display:inline-block;min-width:24px;text-align:center;font-weight:800;border:1px solid rgba(212,175,55,.45);border-radius:6px;padding:1px 6px;margin-left:6px;color:#e9e1c9}
.badge[data-rank="EX"], .badge[data-rank^="S"]{background:rgba(212,175,55,.18)}
.badge[data-rank^="A"]{background:rgba(102,187,106,.18)}
.badge[data-rank^="B"]{background:rgba(100,181,246,.18)}
.badge[data-rank^="C"]{background:rgba(255,202,40,.12)}
.badge[data-rank^="D"]{background:rgba(239,83,80,.12)}
.badge[data-rank^="F"]{background:rgba(176,190,197,.18);color:#e0e6e9}
.detail{border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px;display:grid;grid-template-columns:120px 1fr;gap:12px}
.detail .prev{width:120px;height:120px;border-radius:10px;border:1px solid rgba(212,175,55,.35);background:#1a1d25;object-fit:cover}
.bottom{display:flex;justify-content:space-between;align-items:center}
.modal{overflow:auto}
.sheet{max-height:90vh}
.sright{grid-template-rows:auto 1fr;min-height:420px}
.listc{overflow:auto}
/* Overlay for item detail */
.detailModal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:60}
.detailModal.hidden{display:none}
.detailBox{width:min(560px,92vw);max-height:80vh;overflow:auto;background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px}
.detailHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.detailGrid{display:grid;grid-template-columns:120px 1fr;gap:12px}
  .detailGrid img{
    width:120px;
    height:120px;
    border-radius:10px;
    border:1px solid var(--card);
    object-fit:cover;
    background:#1a1d25
    }

    /* === ë¦¬ìŠ¤íŠ¸ ìš°ì„  ëª¨ë“œìš© === */
  .wrap.list-only{
    grid-template-columns: 1fr;  /* ë¦¬ìŠ¤íŠ¸ë§Œ í•œ ì¤„ë¡œ */
  }

  .wrap.list-only > .card:first-child{
    grid-column: 1 / -1;         /* ì²« ë²ˆì§¸ ì¹´ë“œ(ë¦¬ìŠ¤íŠ¸)ê°€ ì „ì²´ ë„ˆë¹„ ì‚¬ìš© */
  }

  .hidden{
    display: none !important;    /* í¸ì§‘ ì¹´ë“œ ìˆ¨ê¸¸ ë•Œ ì‚¬ìš© */
  }
</style>
</head>
<body>
<header class="header">
  <strong style="font-family:'Cinzel',serif;letter-spacing:.06em">MEMBER ê´€ë¦¬</strong>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <a class="btn outline" href="index.html">â† main</a>
    <!-- ì „ì²´ ë©¤ë²„ ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° -->
    <button id="exportBtn" class="btn outline">ë‚´ë³´ë‚´ê¸°</button>
    <label class="btn outline" style="cursor:pointer">
      ë¶ˆëŸ¬ì˜¤ê¸°
      <input id="importInput" type="file" accept="application/json" hidden>
    </label>
    <!-- âœ… ì¶”ê°€: ì„ íƒëœ ìºë¦­í„°ë§Œ ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° -->
    <button id="exportOneBtn" class="btn outline" title="í˜„ì¬ ì„ íƒëœ ìºë¦­í„°ë§Œ JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°">ì„ íƒ ë‚´ë³´ë‚´ê¸°</button>
    <label class="btn outline" style="cursor:pointer" title="ë‹¨ì¼ ìºë¦­í„° JSON ë¶ˆëŸ¬ì˜¤ê¸°(ë³‘í•©)">
      ì„ íƒ ë¶ˆëŸ¬ì˜¤ê¸°
      <input id="importOneInput" type="file" accept="application/json" hidden>
    </label>
    <!-- ì™¸ë¶€ JSON íŒŒì¼ ì—´ê¸°/ì €ì¥ (File System Access API) -->
    <button id="openDataBtn" class="btn outline" title="ì™¸ë¶€ JSON íŒŒì¼ ì—´ê¸°">ë°ì´í„° ì—´ê¸°</button>
    <button id="saveDataBtn" class="btn outline" title="ì—´ì–´ë‘” JSON íŒŒì¼ì— ì €ì¥">ë°ì´í„° ì €ì¥</button>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: list -->
  <section class="card">
    <div style="display:flex;gap:8px;margin-bottom:10px">
      <button id="newBtn" class="btn">ìƒˆ ìºë¦­í„°</button>
      <button id="saveBtn" class="btn outline">ì €ì¥</button>
      <button id="setRepBtn" class="btn outline" title="ëŒ€í‘œ ìºë¦­í„°ë¡œ ì§€ì •">ëŒ€í‘œ ì§€ì •</button>
    </div>
    <div id="list" class="list"></div>
    <div class="small">íŒ: ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ í¸ì§‘í¼ì— ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</div>
  </section>

  <!-- RIGHT: editor -->
  <section class="card hidden" id="editorCard">
    <div class="grid2">
      <div class="field"><label>ì´ë¦„</label><input id="fName" placeholder="ì˜ˆ: ê³ ì–‘ì´ íƒì •"></div>
      <div class="field"><label>ì§ì—…</label><select id="fRole">
        <option>ì—†ìŒ</option>
        <option>ì „ì‚¬</option>
        <option>ê¸°ì‚¬(ë¹„ê¸°ë„ˆ)</option>
        <option>ê¸°ì‚¬(ìµìŠ¤í¼íŠ¸)</option>
        <option>ê¸°ì‚¬(ë§ˆìŠ¤í„°)</option>
        <option>ì‚¼ë¥˜ ë¬´ì¸(ä¸‰æµ)</option>
        <option>ì´ë¥˜ ë¬´ì¸(äºŒæµ)</option>
        <option>ì¼ë¥˜ ë¬´ì¸(ä¸€æµ)</option>
        <option>ì ˆì •(çµ•é ‚)</option>
        <option>ì´ˆì ˆì •(è¶…çµ•é ‚)</option>
        <option>í™”ê²½(åŒ–å¢ƒ)</option>
        <option>í˜„ê²½(ç„å¢ƒ)</option>
        <option>ì…ë§ˆ(å…¥é­”)</option>
        <option>ê·¹ë§ˆ(æ¥µé­”)</option>
        <option>íƒˆë§ˆ(è„«é­”)</option>
        <option>ê¶ìˆ˜</option>
        <option>ì ˆê¶</option>
        <option>ì•”ì‚´ì</option>
        <option>ë§ˆìˆ ì‚¬</option>
        <option>ë§ˆë²•ì‚¬</option>
        <option>ë§ˆë„ì‚¬</option>
        <option>ìˆ˜ë…€</option>
        <option>ìˆ˜ë„ì›ì¥</option>
        <option>ë¶€ì œ(ë¶€ì‚¬ì œ)</option>
        <option>ì‚¬ì œ</option>
        <option>ì£¼êµ</option>
        <option>ì„±ê¸°ì‚¬</option>
        <option>ì„±ìœ ë¬¼ ê´€ë¦¬ê´€</option>
        <option>ì¶”ê¸°ê²½</option>
        <option>ì„±ê¸°ì‚¬ë‹¨ì¥</option>
        <option>ì´ë‹¨ì‹¬ë¬¸ê´€</option>
        <option>ëŒ€ì£¼êµ</option>
        <option>êµí™©</option>
      </select>
    </div>
      <div class="field"><label>ì¹­í˜¸</label><input id="fSub" placeholder="ì˜ˆ: ë³„ì¹­ / ì†Œì†"></div>
      <div class="field"><label>ì´ë¯¸ì§€</label><input id="fImg" type="file" accept="image/*"></div>
    </div>
    <div class="preview"><img id="imgPrev" alt="preview"><textarea id="fNote" placeholder="ì„¤ëª…, ë°°ê²½ ë“±" style="flex:1;min-height:200px"></textarea></div>

    <hr>
    <h3>ìŠ¤íƒ¯</h3>
    <div class="grid2">
      <div class="field"><label>ê·¼ë ¥</label><input id="stStr" type="number" value="0"></div>
      <div class="field"><label>ë‚´êµ¬</label><input id="stEnd" type="number" value="0"></div>
      <div class="field"><label>ë¯¼ì²©</label><input id="stAgi" type="number" value="0"></div>
      <div class="field"><label>ì§€ë ¥</label><input id="stInt" type="number" value="0"></div>
      <div class="field"><label>ë§ˆë‚˜/ë‚´ë ¥</label><input id="stMana" type="number" value="0"></div>
      </div>
    <hr>
    <h3>íŠ¹ìˆ˜ ëŠ¥ë ¥ì¹˜</h3>
    <div class="grid2">
      <div class="field"><label>í–‰ìš´</label><input id="stLuck" type="number" value="0"></div>
      <!-- í–¥í›„ ì¶”ê°€ ê°€ëŠ¥: ì˜ˆ: ì‹ ì„±ë ¥, ì €í•­ ë“± -->
    </div>
  </div>


    <hr>
    <h3>ì¥ë¹„</h3>
    <div class="grid2">
      <div class="field"><label>ì¥ê°‘</label><input id="eqGlove" placeholder="ì˜ˆ: ê°€ì£½ ì¥ê°‘ +1"></div>
      <div class="field"><label>ë°”ì§€</label><input id="eqPants" placeholder="ì˜ˆ: ì •ì¥ ë°”ì§€"></div>
      <div class="field"><label>ì…”ì¸ </label><input id="eqShirt" placeholder="ì˜ˆ: íšŒìƒ‰ ì…”ì¸ "></div>
      <div class="field"><label>ì‹ ë°œ</label><input id="eqBoots" placeholder="ì˜ˆ: ë¡œí¼"></div>
      <div class="field"><label>ë¬´ê¸°</label><input id="eqWeapon" placeholder="ì˜ˆ: íšŒì¤‘ì‹œê³„(ë¹„ë°€)"></div>
      <div class="field"><label>ì¥ì‹ êµ¬(ëª©ê±¸ì´)</label><input id="eqWeapon" placeholder="ì˜ˆ: íœë˜íŠ¸"></div>
      <div class="field"><label>ì¥ì‹ êµ¬(ë°˜ì§€)</label><input id="eqWeapon" placeholder="ì˜ˆ: ê³ ëª©ë‚˜ë¬´ ë°˜ì§€"></div>
      <div class="field"><label>ì¥ì‹ êµ¬(ë°˜ì§€)</label><input id="eqWeapon" placeholder="ì˜ˆ: ììƒˆì˜ ë°˜ì§€"></div>
    </div>

    <hr>
    <h3>ìŠ¤í‚¬/íŠ¹ì„±</h3>
    <div class="field">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="skillInput" placeholder="ìŠ¤í‚¬ ì´ë¦„ ì…ë ¥ í›„ Enter" style="flex:1;min-width:200px">
        <button class="btn outline" id="pickFromCodex"><i class="fa-solid fa-book"></i> ë„ê°ì—ì„œ ì¶”ê°€</button>
        <label class="btn outline" style="cursor:pointer">íŒŒì¼ ì—…ë¡œë“œ<input id="skillFile" type="file" accept=".json,.csv,.txt" hidden></label>
      </div>
      <div class="small">â€» ë„ê°(compendium.html)ì— ë“±ë¡ëœ í•­ëª©ì„ ë¹ ë¥´ê²Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>
    <div id="skillList"></div>

    <hr>
    <h3>íƒ€ì„ë¼ì¸</h3>
    <div class="grid2">
      <div class="field"><label>ë‚ ì§œ</label><input id="tlDate" type="date"></div>
      <div class="field"><label>ë‚´ìš©</label><input id="tlText" placeholder="ì˜ˆ: ê¸¸ë“œ í•©ë¥˜"></div>
    </div>
    <button id="tlAdd" class="btn outline">ì¶”ê°€</button>
    <div id="timelineWrap" class="small"></div>
  </section>
</div>

<!-- Mini Codex Picker Modal -->
<div id="codexModal" class="modal" role="dialog" aria-modal="true" aria-label="ë„ê° ì„ íƒ">
  <div class="sheet">
    <aside class="sleft">
      <strong style="font-family:'Cinzel',serif">ë„ê°</strong>
      <button class="btn outline" data-type="all">ì „ì²´</button>
      <button class="btn outline" data-type="trait">íŠ¹ì„±</button>
      <button class="btn outline" data-type="tech">ê¸°ìˆ </button>
      <button class="btn outline" data-type="magic">ë§ˆë²•</button>
      <button class="btn outline" data-type="skill">ìŠ¤í‚¬</button>
      <button class="btn outline" data-type="authority">ê¶ŒëŠ¥</button>
      <button class="btn outline" data-type="blessing">ê°€í˜¸</button>
      <button class="btn outline" data-type="proficiency">ìˆ™ë ¨ë„</button>
      <div style="height:1px;background:rgba(255,255,255,.08);margin:8px 0"></div>
      <button class="btn" id="closePicker">ë‹«ê¸°</button>
    </aside>
    <section class="sright">
      <div class="srch">
        <input id="cxQ" placeholder="ê²€ìƒ‰(ì´ë¦„/íƒœê·¸/ë“±ê¸‰)" style="flex:1;min-width:220px">
        <select id="cxRank"><option value="">ë“±ê¸‰ ì „ì²´</option>
          <option>EX</option><option>SSS</option><option>SS</option><option>S+</option><option>S</option>
          <option>A++</option><option>A+</option><option>A</option><option>A-</option>
          <option>B++</option><option>B+</option><option>B</option><option>B-</option>
          <option>C++</option><option>C+</option><option>C</option><option>C-</option>
          <option>D++</option><option>D+</option><option>D</option><option>D-</option>
          <option>F++</option><option>F+</option><option>F</option><option>F-</option>
        </select>
        <select id="cxSort"><option value="name">ê°€ë‚˜ë‹¤ìˆœ</option><option value="rankDesc">ë“±ê¸‰(ê³ â†’ì €)</option></select>
      </div>
      <div class="tags" id="cxTags"></div>
      <div id="cxList" class="listc"></div>
      <div class="bottom">
        <div id="cxSelInfo" class="small">í•­ëª©ì„ ì„ íƒí•˜ë©´ ìƒì„¸ê°€ ë³´ì…ë‹ˆë‹¤.</div>
        <button id="cxAdd" class="btn" disabled>ì¶”ê°€</button>
      </div>
    </section>
  </div>
</div>

  <!-- 1) ê³µí†µ API ë¡œë“œ -->
  <script src="js/api.js"></script>

  <!-- 2) í† í° ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ -->
  <script>
    if (!getToken || !getToken()) {
      window.location.href = 'login.html';
    }
  </script>

  <script>
    /* =========================================================
    *  ìƒìˆ˜ / ë ˆì´ë¸” / ê³µí†µ ìƒíƒœ
    * ======================================================= */

    // localStorage í‚¤ë“¤
    const STORE     = 'members.v1';     // í˜„ì¬ ì‚¬ìš©í•˜ëŠ” ë©¤ë²„ ì €ì¥ì†Œ
    const STORE_OLD = 'memberData.v1';  // ì˜ˆì „ í‚¤(í˜¸í™˜ìš©)
    const REP       = 'representativeId';
    const CODEX     = 'codex.v1';       // ë„ê°(compendium) ì €ì¥ì†Œ

    // ë„ê° íƒ€ì… â†’ í•œê¸€ ë¼ë²¨
    const TYPE_LABELS = {
      trait:       'íŠ¹ì„±',
      tech:        'ê¸°ìˆ ',
      magic:       'ë§ˆë²•',
      skill:       'ìŠ¤í‚¬',
      authority:   'ê¶ŒëŠ¥',
      blessing:    'ê°€í˜¸',
      proficiency: 'ìˆ™ë ¨ë„'
    };

    // ==== ì§ì—… ì •ì˜ (jobId ê¸°ë°˜) ====
    const JOB_DEFS = {
      none: {
        id: 'job_none',
        name: 'ë¬´ì§',
        stat: { str:0, end:0, agi:0, int:0, mana:0, luck:0 },
        resource: 'mana',
        hidden: false
      },
      warrior: {
        id: 'job_warrior',
        name: 'ì „ì‚¬',
        stat: { str:3, end:2, agi:0, int:0, mana:0, luck:0 },
        resource: 'mana',
        hidden: false
      },
      archer: {
        id: 'job_archer',
        name: 'ê¶ìˆ˜',
        stat: { str:1, end:0, agi:3, int:0, mana:0, luck:0 },
        resource: 'mana',
        hidden: false
      },
      assassin: {
        id: 'job_assassin',
        name: 'ì•”ì‚´ì',
        stat: { str:1, end:0, agi:4, int:0, mana:0, luck:0 },
        resource: 'mana',
        hidden: false
      },
      mage: {
        id: 'job_mage',
        name: 'ë§ˆë²•ì‚¬',
        stat: { str:0, end:0, agi:0, int:4, mana:3, luck:0 },
        resource: 'mana',
        hidden: false
      },
      priest: {
        id: 'job_priest',
        name: 'ì„±ì§ì',
        stat: { str:0, end:1, agi:0, int:3, mana:3, luck:0 },
        resource: 'holy',   // â˜… ì„±ì§ìëŠ” ì‹ ì„±ë ¥ ìì› ì‚¬ìš©
        hidden: false
      },
      // ì˜ˆì‹œ íˆë“  ì§ì—… (ì›í•˜ëŠ” ë§Œí¼ ì¶”ê°€ ê°€ëŠ¥)
      hiddenSaint: {
        id: 'job_hidden_saint',
        name: 'ì„±ìì˜ ëŒ€ë¦¬ì',
        stat: { str:2, end:3, agi:1, int:4, mana:5, luck:2 },
        resource: 'holy',
        hidden: true
      }
    };

    const JOB_BY_NAME = {};
    const JOB_BY_ID   = {};
    Object.values(JOB_DEFS).forEach(j => {
      JOB_BY_NAME[j.name] = j;
      JOB_BY_ID[j.id]     = j;
    });

    function getJobForCharacter(ch) {
      if (ch.jobId && JOB_BY_ID[ch.jobId]) return JOB_BY_ID[ch.jobId];
      if (ch.role && JOB_BY_NAME[ch.role]) return JOB_BY_NAME[ch.role];
      return JOB_DEFS.none;
    }

    // ë“±ê¸‰ ì •ë ¬ ê¸°ì¤€ (ì•ì— ìˆì„ìˆ˜ë¡ ë†’ì€ ë“±ê¸‰)
    const RANK_ORDER = [
      'EX','SSS','SS','S+','S',
      'A++','A+','A','A-',
      'B++','B+','B','B-',
      'C++','C+','C','C-',
      'D++','D+','D','D-',
      'F++','F+','F','F-'
    ];

    // ë“±ê¸‰ ë¬¸ìì—´ â†’ ì¸ë±ìŠ¤ (ì‘ì„ìˆ˜ë¡ ë†’ì€ ë“±ê¸‰, ì—†ìœ¼ë©´ 999)
    const rankIndex = r => {
      const i = RANK_ORDER.indexOf(r || '');
      return i === -1 ? 999 : i;
    };

    // id ì„ íƒ ë‹¨ì¶•
    const $id = id => document.getElementById(id);

    // í™”ë©´/ë°ì´í„° ê³µí†µ ìƒíƒœ
    const S = {
      list:      [],       // ì „ì²´ ìºë¦­í„° ëª©ë¡
      currentId: null,     // í˜„ì¬ ì„ íƒëœ ìºë¦­í„° id
      skills:    [],       // í˜„ì¬ ìºë¦­í„°ì˜ ìŠ¤í‚¬/íŠ¹ì„± ë°°ì—´
      timeline:  [],       // íƒ€ì„ë¼ì¸(í…ìŠ¤íŠ¸ ë¡œê·¸)
      imgData:   ''        // ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ ë°ì´í„°(ë¯¸ë¦¬ë³´ê¸°ìš©)
    };

    // ==== ë¡œê·¸ì¸ ìœ ì € ì •ë³´ / ê¶Œí•œ ê´€ë ¨ ====
    let currentUser = null;

    // /api/me í˜¸ì¶œí•´ì„œ í˜„ì¬ ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    async function loadCurrentUser() {
      try {
        const res = await fetchMe();    // api.jsì— ì´ë¯¸ ìˆìŒ
        currentUser = res && res.user ? res.user : null;
      } catch (e) {
        console.error('í˜„ì¬ ìœ ì € ì •ë³´ ë¡œë“œ ì‹¤íŒ¨', e);
        currentUser = null;
      }
    }

    // admin ì—¬ë¶€
    function isAdmin() {
      return currentUser && currentUser.role === 'admin';
    }

    // íŠ¹ìˆ˜ ì¡°ê±´(ì¶”ê°€ ìºë¦­í„° ìŠ¬ë¡¯ í•´ê¸ˆ ì—¬ë¶€)
    // - ê²Œì„ ë‚´ì—ì„œ ì¡°ê±´ ë‹¬ì„± ì‹œ localStorage.setItem('extraCharUnlocked','1') ê°™ì€ ì‹ìœ¼ë¡œ ì„¸íŒ…í•œë‹¤ê³  ê°€ì •
    function hasExtraSlot() {
      return localStorage.getItem('extraCharUnlocked') === '1';
    }

    // "ìƒˆ ìºë¦­í„°" ë²„íŠ¼ ë…¸ì¶œ ì—¬ë¶€ ì ìš©
    function applyCreateButtonVisibility() {
      const btn = $id('newBtn');
      if (!btn) return;

      if (isAdmin() || hasExtraSlot()) {
        btn.style.display = 'inline-flex';   // ë²„íŠ¼ ë³´ì´ê¸°
      } else {
        btn.style.display = 'none';          // ì¼ë°˜ ìœ ì €ëŠ” ìˆ¨ê¹€
      }
    }

    /* âœ… ì¶”ê°€: ì¼ë°˜ ìœ ì €ëŠ” í¸ì§‘/ì €ì¥ ë¶ˆê°€ (ì½ê¸° ì „ìš© ì ê¸ˆ) */
    function applyEditLockForNonAdmin() {
      if (isAdmin()) {
        // ê´€ë¦¬ìë©´ ì•„ë¬´ ê²ƒë„ ë§‰ì§€ ì•ŠìŒ
        return;
      }

      // 1) ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
      const saveBtn = $id('saveBtn');
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.title = 'ì¼ë°˜ ìœ ì €ëŠ” ìºë¦­í„°ë¥¼ ìˆ˜ì •/ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      }

      // 2) ì…ë ¥ í•„ë“œ/ìŠ¤íƒ¯/ì¥ë¹„/ë…¸íŠ¸ ë“± ì½ê¸° ì „ìš©
      const readOnlyIds = [
        'fName','fRole','fSub','fNote',
        'stStr','stEnd','stAgi','stInt','stMana','stLuck',
        'eqGlove','eqPants','eqShirt','eqBoots','eqWeapon',
        'skillInput','tlDate','tlText'
      ];

      readOnlyIds.forEach(id => {
        const el = $id(id);
        if (!el) return;
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') {
          el.readOnly = true;
          el.disabled = true;   // select ê°™ì€ ê±´ disabledë¡œ
        }
      });

      // 3) íŒŒì¼/ë²„íŠ¼ë¥˜ ë§‰ê¸° (ì´ë¯¸ì§€ ì—…ë¡œë“œ, ìŠ¤í‚¬ íŒŒì¼, íƒ€ì„ë¼ì¸ ì¶”ê°€, ë„ê° ì„ íƒ ë“±)
      const disableIds = ['fImg','skillFile','tlAdd','pickFromCodex'];
      disableIds.forEach(id => {
        const el = $id(id);
        if (el) el.disabled = true;
      });

      const disableButtons = [
        'exportBtn','importInput',
        'exportOneBtn','importOneInput',
        'openDataBtn','saveDataBtn'
      ];

      disableButtons.forEach(id => {
        const el = $id(id);
        if (el) el.disabled = true;
      });
    }


    /* =========================================================
    *  DOM ì°¸ì¡° & ë·° ëª¨ë“œ ì „í™˜
    * ======================================================= */

    const listEl   = $id('list');
    const imgPrev  = $id('imgPrev');
    const wrapEl   = document.querySelector('.wrap');
    const editorEl = document.getElementById('editorCard');

    /**
     * ë³´ê¸° ëª¨ë“œ ì „í™˜
     * - 'list' : ìºë¦­í„° ë¦¬ìŠ¤íŠ¸ë§Œ
     * - 'edit' : ì˜¤ë¥¸ìª½ í¸ì§‘ í¼ê¹Œì§€ í‘œì‹œ
     */
    function setViewMode(mode){
      if (!wrapEl || !editorEl) return;
      if (mode === 'edit'){
        wrapEl.classList.remove('list-only');
        editorEl.classList.remove('hidden');
      } else {
        wrapEl.classList.add('list-only');
        editorEl.classList.add('hidden');
      }
    }

    /* =========================================================
    *  ì´ˆê¸° ë¡œë”© / ì €ì¥ ìœ í‹¸
    * ======================================================= */

    // ëœë¤ id ìƒì„±
    function uid() {
      return Math.random().toString(36).slice(2, 9);
    }

/// ì„œë²„ + localStorage â†’ ë©¤ë²„ ëª©ë¡ ë¡œë”©
async function loadInitialMembers() {
  // 1) ë¨¼ì € ì„œë²„ì—ì„œ ì‹œë„
  try {
    const serverList = await apiGet('/api/members');

    if (Array.isArray(serverList)) {
      // 1-1) ì„œë²„ì— ì´ë¯¸ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì§„ì‹¤ë¡œ ì‚¬ìš©
      if (serverList.length > 0) {
        S.list = serverList;
        saveMembersToLocal(); // ë¡œì»¬ ìºì‹œ ë®ì–´ì“°ê¸°
        return;
      }

      // 1-2) ì„œë²„ëŠ” ë¹„ì–´ ìˆê³ , ë¡œì»¬ì—ë§Œ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° â†’ ìµœì´ˆ ë§ˆì´ê·¸ë ˆì´ì…˜
      try {
        const cur = JSON.parse(localStorage.getItem(STORE) || '[]');
        const old = JSON.parse(localStorage.getItem(STORE_OLD) || '[]');

        const localList =
          (Array.isArray(cur) && cur.length) ? cur :
          (Array.isArray(old) && old.length) ? old : [];

        if (localList.length > 0) {
          // ë¡œì»¬ ë°ì´í„°ë¥¼ ì„œë²„ + ë¡œì»¬ì— ëª¨ë‘ ì €ì¥
          S.list = localList;
          await saveMembersToStorage(); // ì´ ì•ˆì—ì„œ ì„œë²„ + ë¡œì»¬ ë‘˜ ë‹¤ ì €ì¥
        } else {
          // ë¡œì»¬ë„ ë¹„ì–´ ìˆìœ¼ë©´ ê·¸ëƒ¥ ë¹ˆ ìƒíƒœë¡œ ê³ ì •
          S.list = [];
          saveMembersToLocal();
        }
      } catch (e) {
        console.error(e);
        S.list = [];
      }
      return;
    }
  } catch (e) {
    console.error('ì„œë²„ì—ì„œ ë©¤ë²„ ë¡œë“œ ì‹¤íŒ¨', e);
  }

  // 2) ì„œë²„ ìš”ì²­ ìì²´ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ localStorage ì‚¬ìš©
  try {
    const cur = JSON.parse(localStorage.getItem(STORE) || '[]');
    const old = JSON.parse(localStorage.getItem(STORE_OLD) || '[]');

    if (Array.isArray(cur) && cur.length) {
      S.list = cur;
    } else if (Array.isArray(old) && old.length) {
      S.list = old;
      saveMembersToLocal(); // ì˜› í‚¤ â†’ ìƒˆ í‚¤ ìŠ¹ê²©
    } else {
      S.list = [];
    }
  } catch (e) {
    console.error(e);
    S.list = [];
  }
}

// ì„œë²„ + ë¡œì»¬ ì €ì¥
async function saveMembersToStorage() {
  try {
    // 1) ì„œë²„ì— ì €ì¥
    await apiPost('/api/members', { members: S.list });
  } catch (e) {
    console.error('ì„œë²„ ë©¤ë²„ ì €ì¥ ì˜¤ë¥˜', e);
  }

  // 2) ì„œë²„ê°€ ì‹¤íŒ¨í•˜ë”ë¼ë„ ë¡œì»¬ì—ëŠ” ìµœëŒ€í•œ ì €ì¥
  saveMembersToLocal();
}

// ìˆœìˆ˜ localStorage ì €ì¥ ì „ë‹´
function saveMembersToLocal() {
  try {
    localStorage.setItem(STORE,     JSON.stringify(S.list));
    localStorage.setItem(STORE_OLD, JSON.stringify(S.list));
  } catch (e) {
    console.error('members ì €ì¥ ì˜¤ë¥˜', e);
  }
}

    /* =========================================================
    *  ìŠ¤í‚¬ ë°°ì—´ ì¤‘ë³µ ì²´í¬ (ë¬¸ìì—´/ê°ì²´ í˜¼í•© ëŒ€ì‘)
    * ======================================================= */

    /**
     * í˜„ì¬ S.skills ì—
     * - ë™ì¼í•œ codexId, ë˜ëŠ”
     * - ë™ì¼í•œ name + rank
     * ë¥¼ ê°€ì§„ í•­ëª©ì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
     */
    function hasSkill(name, rank, codexId) {
      const n = (name    || '').trim();
      const r = (rank    || '').trim();
      const c = (codexId || '').trim();

      return S.skills.some(s => {
        if (!s) return false;

        // 1) codexIdê°€ ë‘˜ ë‹¤ ìˆìœ¼ë©´ codexId ê¸°ì¤€ìœ¼ë¡œ ë¹„êµ
        const sCid = (s.codexId || '').trim();
        if (c && sCid && sCid === c) return true;

        // 2) ë‚˜ë¨¸ì§€ëŠ” name + rank ê¸°ì¤€
        if (typeof s === 'string') {
          // ì˜› í˜•ì‹: ë¬¸ìì—´ë§Œ ìˆì„ ë•ŒëŠ” ì´ë¦„ë§Œ ë¹„êµ (ë“±ê¸‰ ì •ë³´ ì—†ìŒ)
          return s === n && !r;
        }

        const sn = (s.name || '').trim();
        const sr = (s.rank || '').trim();
        return sn === n && sr === r;
      });
    }

    /* =========================================================
    *  ìºë¦­í„° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    * ======================================================= */

    function drawList() {
      listEl.innerHTML = '';

      if (!S.list.length) {
        listEl.innerHTML =
          '<div class="small" style="grid-column:1/-1;">ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</div>';
        return;
      }

      // ğŸ”¹ ëŒ€í‘œ ìºë¦­í„° id ê°€ì ¸ì˜¤ê¸°
      const repId = localStorage.getItem(REP);

      S.list.forEach(ch => {
        const item = document.createElement('div');
        item.className = 'item';

        const isCurrent = ch.id === S.currentId;
        const isRep     = repId && ch.id === repId;

        if (isCurrent) item.classList.add('active');

        const img = ch.img
          ? `<img src="${ch.img}" alt="" class="thumb">`
          : `<img src="https://via.placeholder.com/300x200/2a2a2a/888?text=NO+IMAGE" class="thumb" alt="">`;

        item.innerHTML = `
          ${img}
          <div class="meta">
            <strong>${ch.name || 'ë¬´ëª…'}</strong>
            <div class="small">
              ${ch.role || 'ì—­í•  ë¯¸ì§€ì •'}
              ${isRep ? '<span class="badge" style="margin-left:4px;">ëŒ€í‘œ</span>' : ''}
            </div>
          </div>
        `;

        // ì¹´ë“œ í´ë¦­ â†’ í¼ì— ë¶ˆëŸ¬ì˜¤ê³  í¸ì§‘ ëª¨ë“œë¡œ ì „í™˜
        item.onclick = () => {
          loadToForm(ch.id);
          setViewMode('edit');
        };

        listEl.appendChild(item);
      });

      // ë¦¬ìŠ¤íŠ¸ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì €ì¥
      saveMembersToStorage();
    }

    /* =========================================================
    *  í¼ì— ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ê¸° / ë¦¬ì…‹
    * ======================================================= */

    // idë¡œ ìºë¦­í„° ì°¾ì•„ í¼ì— ì±„ìš°ê¸°
    function loadToForm(id) {
      const ch = S.list.find(v => v.id === id);
      if (!ch) return;

      setViewMode('edit'); // ì–´ë””ì„œ í˜¸ì¶œë˜ë“  ìºë¦­í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ í¸ì§‘ ëª¨ë“œ

      S.currentId = id;
      S.skills    = Array.isArray(ch.skills)   ? [...ch.skills]   : [];
      S.timeline  = Array.isArray(ch.timeline) ? [...ch.timeline] : [];
      S.imgData   = ch.img || '';

      // ê¸°ë³¸ ì •ë³´
      $id('fName').value = ch.name || '';
      $id('fRole').value = ch.role || '';
      $id('fSub').value  = ch.sub  || '';
      $id('fNote').value = ch.note || '';

      imgPrev.src = ch.img || '';

      // ìŠ¤íƒ¯ (ì˜› í‚¤ atk/def/spd/hp í˜¸í™˜)
      const st = ch.stats || {};
      $id('stStr').value  = st.str  ?? st.atk ?? 0;
      $id('stEnd').value  = st.end  ?? st.def ?? 0;
      $id('stAgi').value  = st.agi  ?? st.spd ?? 0;
      $id('stInt').value  = st.int  ?? 0;
      $id('stMana').value = st.mana ?? st.hp  ?? 0;
      $id('stLuck').value = st.luck ?? 0;

      // ì¥ë¹„
      const eq = ch.equip || {};
      $id('eqGlove').value  = eq.glove  || '';
      $id('eqPants').value  = eq.pants  || '';
      $id('eqShirt').value  = eq.shirt  || '';
      $id('eqBoots').value  = eq.boots  || '';
      $id('eqWeapon').value = eq.weapon || '';

      drawSkills();
      drawTimeline();
      drawList();
    }

    // í¼ì„ ë¹„ì›Œì„œ ìƒˆ ìºë¦­í„° ì…ë ¥ ì¤€ë¹„
    function resetForm() {
      S.currentId = null;
      S.skills    = [];
      S.timeline  = [];
      S.imgData   = '';

      $id('fName').value = '';
      $id('fRole').value = 'ì—†ìŒ';  // í˜¹ì€ option ì¤‘ í•˜ë‚˜ì˜ valueë¡œ
      $id('fSub').value  = '';
      $id('fNote').value = '';

      imgPrev.src = '';
      const fImg = $id('fImg');
      if (fImg) fImg.value = '';

      $id('stStr').value  = 0;
      $id('stEnd').value  = 0;
      $id('stAgi').value  = 0;
      $id('stInt').value  = 0;
      $id('stMana').value = 0;
      $id('stLuck').value = 0;

      $id('eqGlove').value  = '';
      $id('eqPants').value  = '';
      $id('eqShirt').value  = '';
      $id('eqBoots').value  = '';
      $id('eqWeapon').value = '';

      drawSkills();
      drawTimeline();
      drawList();
    }

    /* =========================================================
    *  ìºë¦­í„° ì €ì¥ (ì´ë¯¸ì§€ í¬í•¨)
    * ======================================================= */

    function save() {
      // âœ… ê´€ë¦¬ìë§Œ ìˆ˜ì •/ì €ì¥ ê°€ëŠ¥
      if (!isAdmin()) {
        alert('ìºë¦­í„° í¸ì§‘ ë° ì €ì¥ì€ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }

      const id       = S.currentId || uid();
      const existing = S.list.find(c => c.id === id);

      // ìŠ¤íƒ¯
      const stats = {
        str:  +($id('stStr').value  || 0),
        end:  +($id('stEnd').value  || 0),
        agi:  +($id('stAgi').value  || 0),
        int:  +($id('stInt').value  || 0),
        mana: +($id('stMana').value || 0),
        luck: +($id('stLuck').value || 0)
      };

      // ì¥ë¹„
      const equip = {
        glove:  ($id('eqGlove').value  || '').trim(),
        pants:  ($id('eqPants').value  || '').trim(),
        shirt:  ($id('eqShirt').value  || '').trim(),
        boots:  ($id('eqBoots').value  || '').trim(),
        weapon: ($id('eqWeapon').value || '').trim()
      };

      // ì—…ë¡œë“œí•œ ì´ë¯¸ì§€
      const imgData = S.imgData || (existing && existing.img) || imgPrev.src || '';

      // â˜… role í…ìŠ¤íŠ¸ â†’ jobId ë§¤í•‘
      const roleName = ($id('fRole').value || '').trim();
      const job      = JOB_BY_NAME[roleName] || JOB_DEFS.none;

      const d = {
        id,
        name: ($id('fName').value || '').trim(),
        role: roleName,
        // â˜… ì§ì—… ì‹œìŠ¤í…œ ë‚´ë¶€ id
        jobId: job.id,
        sub:  ($id('fSub').value  || '').trim(),
        note: ($id('fNote').value || '').trim(),
        img:  imgData,
        stats,
        equip,
        // S.skills / S.timeline ë°°ì—´ì„ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ì„œ ì €ì¥
        skills:   Array.isArray(S.skills)   ? [...S.skills]   : [],
        timeline: Array.isArray(S.timeline) ? [...S.timeline] : []
      };

      const idx = S.list.findIndex(c => c.id === id);
      if (idx >= 0) S.list[idx] = d;
      else          S.list.push(d);

      S.currentId = id;
      saveMembersToStorage();
      drawList();
      alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    /* =========================================================
    *  ìŠ¤í‚¬ / íƒ€ì„ë¼ì¸ ë Œë”ë§
    * ======================================================= */

    // ìŠ¤í‚¬/íŠ¹ì„± pill ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
    function drawSkills() {
      const box = $id('skillList');
      box.innerHTML = '';

      if (!S.skills.length) {
        box.innerHTML = '<div class="small">(ìŠ¤í‚¬/íŠ¹ì„± ì—†ìŒ)</div>';
        return;
      }

      S.skills.forEach((s, i) => {
        const pill = document.createElement('span');
        pill.className = 'pill';

        let label = '';
        if (typeof s === 'string') {
          // ì˜› ë°ì´í„°: ì´ë¦„ë§Œ ë¬¸ìì—´
          label = s;
        } else if (s && typeof s === 'object') {
          label = s.name || '';
          if (s.rank) {
            label += ` [${s.rank}]`;
          }
          if (s.type && TYPE_LABELS[s.type]) {
            label += ` Â· ${TYPE_LABELS[s.type]}`;
          }
        } else {
          label = String(s);
        }

        pill.textContent = label;

        // âœ… ê´€ë¦¬ìë§Œ ì‚­ì œ ê°€ëŠ¥
        if (isAdmin()) {
          pill.onclick = () => {
            if (confirm(`"${label}" ì„(ë¥¼) ì œê±°í• ê¹Œìš”?`)) {
              S.skills.splice(i, 1);
              drawSkills();
            }
          };
        } else {
          pill.onclick = null;   // ì¼ë°˜ ìœ ì €ëŠ” í´ë¦­í•´ë„ ì•„ë¬´ ì¼ë„ ì•ˆ ì¼ì–´ë‚¨
        }

        box.appendChild(pill);
      });
    }
    // ì‹œê°„ìˆœ í…ìŠ¤íŠ¸ë§Œ ë³´ì—¬ì£¼ëŠ” íƒ€ì„ë¼ì¸
    function drawTimeline() {
      const wrap = $id('timelineWrap');
      if (!S.timeline.length) {
        wrap.innerHTML = '<span class="small">(ë¹„ì–´ ìˆìŒ)</span>';
        return;
      }
      wrap.innerHTML = S.timeline
        .map(t => `â€¢ ${t.date || ''} â€“ ${t.text || ''}`)
        .join('<br>');
    }

    /* =========================================================
    *  ë©¤ë²„ JSON íŒŒì¼ ë‚´ë³´ë‚´ê¸° / ê°€ì ¸ì˜¤ê¸°
    * ======================================================= */

    // JSON ë‹¤ìš´ë¡œë“œ (members.json)
    function exportMembers() {
      const blob = new Blob([JSON.stringify(S.list, null, 2)], {
        type: 'application/json'
      });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'members.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // JSON íŒŒì¼ì—ì„œ ë©¤ë²„ ë°°ì—´ ê°€ì ¸ì˜¤ê¸°
    function importMembersFromFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const arr = JSON.parse(reader.result);
          if (Array.isArray(arr)) {
            S.list      = arr;
            S.currentId = null;
            S.skills    = [];
            S.timeline  = [];
            S.imgData   = '';
            drawList();
            alert('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ');
          } else {
            alert('JSON ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
          }
        } catch (e) {
          alert('JSON íŒŒì‹± ì‹¤íŒ¨');
        }
      };
      reader.readAsText(file);
    }

    // âœ… ë‹¨ì¼ ë©¤ë²„ë§Œ JSONìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
    function exportCurrentMember() {
      if (!S.currentId) {
        alert('ë¨¼ì € í¸ì§‘ ì¤‘ì´ê±°ë‚˜ ì„ íƒëœ ìºë¦­í„°ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      const ch = S.list.find(c => c.id === S.currentId);
      if (!ch) {
        alert('ì„ íƒëœ ìºë¦­í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const blob = new Blob([JSON.stringify(ch, null, 2)], {
        type: 'application/json'
      });

      const a = document.createElement('a');
      const safeName = (ch.name || 'member').replace(/[\\\/:*?"<>|]+/g, '_');
      a.href = URL.createObjectURL(blob);
      a.download = `member_${safeName}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // âœ… ë‹¨ì¼ ë©¤ë²„ JSONì„ ì½ì–´ì™€ ë¦¬ìŠ¤íŠ¸ì— ë³‘í•©
    function importSingleMemberFromFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          let m = null;

          // í˜¹ì‹œ ë°°ì—´ë¡œ ë“¤ì–´ì™€ë„ ì²« ë²ˆì§¸ ì›ì†Œë¥¼ ë©¤ë²„ë¡œ ì‚¬ìš©
          if (Array.isArray(parsed)) {
            if (!parsed.length) {
              alert('JSON ë°°ì—´ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
              return;
            }
            m = parsed[0];
          } else if (parsed && typeof parsed === 'object') {
            m = parsed;
          } else {
            alert('ë‹¨ì¼ ìºë¦­í„° ê°ì²´(JSON) í˜•íƒœê°€ ì•„ë‹™ë‹ˆë‹¤.');
            return;
          }

          // id ì—†ìœ¼ë©´ ìƒˆë¡œ ë¶€ì—¬
          if (!m.id) m.id = uid();

          const idx = S.list.findIndex(c => c.id === m.id);

          // ë™ì¼ id ì¡´ì¬ ì‹œ ë®ì–´ì“¸ì§€ ë¬¼ì–´ë³´ê³  êµì²´
          if (idx >= 0) {
            if (!confirm('ê°™ì€ IDë¥¼ ê°€ì§„ ìºë¦­í„°ê°€ ìˆì–´ í•´ë‹¹ ìºë¦­í„°ë¥¼ ë®ì–´ì“¸ê¹Œìš”?')) {
              return;
            }
            S.list[idx] = m;
          } else {
            // ìƒˆ ìºë¦­í„°ë¡œ ì¶”ê°€
            S.list.push(m);
          }

          // ì €ì¥ + í™”ë©´ ë°˜ì˜
          saveMembersToStorage();
          S.currentId = m.id;
          S.skills    = Array.isArray(m.skills)   ? [...m.skills]   : [];
          S.timeline  = Array.isArray(m.timeline) ? [...m.timeline] : [];
          S.imgData   = m.img || '';

          drawList();
          loadToForm(m.id);
          alert('ìºë¦­í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        } catch (e) {
          console.error(e);
          alert('JSON íŒŒì‹±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      };
      reader.readAsText(file);
    }

    /* =========================================================
    *  ë„ê°(codex) ë°ì´í„° ë¡œë”©
    * ======================================================= */

    function loadCodex() {
      try {
        const arr = JSON.parse(localStorage.getItem(CODEX) || '[]');
        return Array.isArray(arr) ? arr : [];
      } catch (e) {
        console.error('codex ë¡œë“œ ì‹¤íŒ¨', e);
        return [];
      }
    }

    /* =========================================================
    *  ë„ê° ë¯¸ë‹ˆ í”¼ì»¤(ëª¨ë‹¬) ê´€ë ¨ ìƒíƒœ / DOM
    * ======================================================= */

    const codexModal = $id('codexModal');
    const cxQ        = $id('cxQ');
    const cxRank     = $id('cxRank');
    const cxSort     = $id('cxSort');
    const cxTags     = $id('cxTags');
    const cxList     = $id('cxList');
    const cxSelInfo  = $id('cxSelInfo');
    const cxAdd      = $id('cxAdd');

    let cxData       = [];         // ë„ê° ì „ì²´ ë°°ì—´
    let cxFilterType = 'all';      // ì¢Œì¸¡ íƒ€ì… í•„í„°
    let cxSelected   = null;       // í˜„ì¬ ì„ íƒëœ ë„ê° í•­ëª©
    let cxActiveTags = new Set();  // íƒœê·¸ í•„í„°

    /* ---------------------------------------------------------
    *  ë„ê° íƒœê·¸ ì¹© ìƒì„±
    * ------------------------------------------------------ */

    function buildCxTags() {
      cxTags.innerHTML = '';
      const map = new Map();

      // íƒœê·¸ ì¢…ë¥˜ ìˆ˜ì§‘
      cxData.forEach(x => {
        (x.tags || '')
          .split(/[,\s]+/)
          .map(t => t.trim())
          .filter(Boolean)
          .forEach(t => map.set(t, true));
      });

      const tags = Array.from(map.keys());
      if (!tags.length) {
        cxTags.innerHTML = '<span class="small">(íƒœê·¸ ì—†ìŒ)</span>';
        return;
      }

      tags.forEach(tag => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'tag';
        btn.textContent = tag;

        if (cxActiveTags.has(tag)) btn.classList.add('active');

        btn.onclick = () => {
          if (cxActiveTags.has(tag)) cxActiveTags.delete(tag);
          else cxActiveTags.add(tag);
          renderCxList();
        };

        cxTags.appendChild(btn);
      });
    }

    /* ---------------------------------------------------------
    *  ë„ê° ë¦¬ìŠ¤íŠ¸ í•„í„°ë§/ì •ë ¬
    * ------------------------------------------------------ */

    function filteredCx() {
      let arr = cxData.slice();

      // íƒ€ì… í•„í„° (íŠ¹ì„±/ê¸°ìˆ /ë§ˆë²•/â€¦)
      if (cxFilterType !== 'all') {
        arr = arr.filter(x => x.type === cxFilterType);
      }

      // ê²€ìƒ‰ì–´(ì´ë¦„/íƒœê·¸/ì„¤ëª…)
      const term = (cxQ.value || '').toLowerCase().trim();
      if (term) {
        arr = arr.filter(x => {
          const name = (x.name || '').toLowerCase();
          const tags = (x.tags || '').toLowerCase();
          const desc = (x.desc || '').toLowerCase();
          return (
            name.includes(term) ||
            tags.includes(term) ||
            desc.includes(term)
          );
        });
      }

      // íƒœê·¸ í•„í„°
      if (cxActiveTags.size) {
        arr = arr.filter(x => {
          const tags = (x.tags || '')
            .split(/[,\s]+/)
            .map(t => t.trim())
            .filter(Boolean);
          return tags.some(t => cxActiveTags.has(t));
        });
      }

      // ë“±ê¸‰ í•„í„° (ì„ íƒëœ ë“±ê¸‰ ì´ìƒ)
      const rankVal = cxRank ? cxRank.value : '';
      if (rankVal) {
        const minIdx = rankIndex(rankVal);
        arr = arr.filter(x => rankIndex(x.rank) <= minIdx);
      }

      // ì •ë ¬ (ì´ë¦„ / ë“±ê¸‰)
      const sortVal = cxSort ? cxSort.value : 'rank';
      if (sortVal === 'name') {
        arr.sort((a, b) =>
          (a.name || '').localeCompare(b.name || '', 'ko')
        );
      } else {
        arr.sort((a, b) => {
          const d = rankIndex(a.rank) - rankIndex(b.rank);
          if (d !== 0) return d;
          return (a.name || '').localeCompare(b.name || '', 'ko');
        });
      }

      return arr;
    }

    /* ---------------------------------------------------------
    *  ë„ê° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ + ìƒì„¸
    * ------------------------------------------------------ */

    function renderCxList() {
      const arr = filteredCx();
      cxList.innerHTML = '';

      if (!arr.length) {
        cxList.innerHTML =
          '<div class="small">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        cxSelInfo.textContent = 'í•­ëª©ì„ ì„ íƒí•˜ë©´ ìƒì„¸ê°€ ë³´ì…ë‹ˆë‹¤.';
        cxAdd.disabled = true;
        return;
      }

      // ì¹´ë“œ ëª©ë¡
      arr.forEach(x => {
        const card = document.createElement('div');
        card.className = 'cardc';

        // ê°™ì€ ì´ë¦„ì´ ì—¬ëŸ¬ ê°œ ìˆì–´ë„ "ê°™ì€ idì¸ ì¹´ë“œ"ë§Œ ì„ íƒ í‘œì‹œ
        if (cxSelected && cxSelected.id === x.id) {
          card.classList.add('selected');
        }

        card.innerHTML = `
          <div class="thc" style="background-image:url('${x.icon || ''}')"></div>
          <div class="meta">
            <strong>${x.name || ''}</strong>
            <div class="small">
              ${(TYPE_LABELS[x.type] || x.type || '')}
              ${x.rank ? `<span class="badge" data-rank="${x.rank}">${x.rank}</span>` : ''}
            </div>
          </div>
        `;

        card.onclick = () => {
          cxSelected = x;
          renderCxList(); // ë‹¤ì‹œ ê·¸ë ¤ì„œ ì„ íƒ í‘œì‹œ/ìƒì„¸ ê°±ì‹ 
        };

        cxList.appendChild(card);
      });

      // ìƒì„¸/í•˜ë‹¨ ì •ë³´
      if (cxSelected) {
        cxSelInfo.innerHTML = `
          <div class="detail">
            <img class="prev" src="${cxSelected.icon || ''}" alt="">
            <div>
              <strong>${cxSelected.name || ''}</strong>
              ${cxSelected.rank ? `<span class="badge" data-rank="${cxSelected.rank}">${cxSelected.rank}</span>` : ''}
              <div class="small" style="margin:4px 0">
                ${(TYPE_LABELS[cxSelected.type] || cxSelected.type || '')}
                ${cxSelected.tags ? ' Â· ' + cxSelected.tags : ''}
              </div>
              <div>${cxSelected.desc || ''}</div>
            </div>
          </div>
        `;
        cxAdd.disabled = false;
      } else {
        cxSelInfo.textContent = 'í•­ëª©ì„ ì„ íƒí•˜ë©´ ìƒì„¸ê°€ ë³´ì…ë‹ˆë‹¤.';
        cxAdd.disabled = true;
      }
    }

    /* ---------------------------------------------------------
    *  ë„ê° í”¼ì»¤ ì—´ê¸°/ë‹«ê¸°
    * ------------------------------------------------------ */

    function openPicker() {
      if (!codexModal) {
        alert('ë„ê° ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      cxData = loadCodex();
      if (!cxData.length) {
        cxList.innerHTML =
          '<div class="small">ë„ê°ì— ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. compendium.htmlì—ì„œ í•­ëª©ì„ ë¨¼ì € ì¶”ê°€í•´ ì£¼ì„¸ìš”.</div>';
        cxSelInfo.textContent = '';
      }

      cxFilterType = 'all';
      cxSelected   = null;
      cxActiveTags.clear();

      if (cxQ)    cxQ.value    = '';
      if (cxRank) cxRank.value = '';
      if (cxSort) cxSort.value = 'rank';

      buildCxTags();
      renderCxList();
      codexModal.classList.add('show');
    }

    function closePicker() {
      if (codexModal) codexModal.classList.remove('show');
    }

    /* =========================================================
    *  ì´ë²¤íŠ¸ ë°”ì¸ë”©
    * ======================================================= */

    function bindEvents() {
      // ìƒˆ ìºë¦­í„°
      $id('newBtn').onclick = () => {
        resetForm();
        setViewMode('edit');
      };

      // ì €ì¥ ë²„íŠ¼
      $id('saveBtn').onclick = save;

      // ëŒ€í‘œ ìºë¦­í„° ì§€ì •
      $id('setRepBtn').onclick = () => {
        if (!S.currentId) {
          alert('ë¨¼ì € ìºë¦­í„°ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì €ì¥í•´ ì£¼ì„¸ìš”.');
          return;
        }
        localStorage.setItem(REP, S.currentId);

        // ğŸ”¹ ë¦¬ìŠ¤íŠ¸ì— ë°”ë¡œ ëŒ€í‘œ ë°°ì§€ ë°˜ì˜
        drawList();

        alert('ëŒ€í‘œ ìºë¦­í„°ë¡œ ì§€ì •í–ˆìŠµë‹ˆë‹¤.');
      };

      /* --- ì´ë¯¸ì§€ ì—…ë¡œë“œ (ìš©ëŸ‰ ì¶•ì†Œ í›„ DataURL ì €ì¥) --- */

      $id('fImg').onchange = e => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        const img = new Image();
        const url = URL.createObjectURL(file);

        img.onload = () => {
          // ìµœëŒ€ í•œ ë³€ 512px ì •ë„ë¡œ ì¶•ì†Œ (ìš©ëŸ‰ ì¤„ì´ê¸°)
          const maxSize = 512;
          const scale = Math.min(
            maxSize / img.width,
            maxSize / img.height,
            1
          );

          const canvas = document.createElement('canvas');
          canvas.width  = Math.round(img.width  * scale);
          canvas.height = Math.round(img.height * scale);

          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          // JPEGë¡œ ì¸ì½”ë”©í•´ì„œ ìš©ëŸ‰ ë” ì¤„ì´ê¸°
          const dataUrl = canvas.toDataURL('image/jpeg', 0.85);

          // ë¯¸ë¦¬ë³´ê¸° + ì‹¤ì œ ì €ì¥ë  ë°ì´í„°
          S.imgData  = dataUrl;
          imgPrev.src = dataUrl;

          URL.revokeObjectURL(url);
        };

        img.onerror = () => {
          URL.revokeObjectURL(url);
          alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        };

        img.src = url;
      };

      /* --- ìŠ¤í‚¬ ì…ë ¥(ì—”í„°) / íŒŒì¼ì—ì„œ ìŠ¤í‚¬ ë¶ˆëŸ¬ì˜¤ê¸° --- */

      const skillInput = $id('skillInput');

      // í…ìŠ¤íŠ¸ ì…ë ¥ í›„ ì—”í„° â†’ skills ë°°ì—´ì— ë¬¸ìì—´ ì¶”ê°€
      skillInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const v = skillInput.value.trim();
          if (v) {
            S.skills.push(v);
            skillInput.value = '';
            drawSkills();
          }
        }
      });

      // .json / .csv / .txt íŒŒì¼ì—ì„œ ìŠ¤í‚¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      $id('skillFile').onchange = e => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;

        const r = new FileReader();
        r.onload = () => {
          const text = String(r.result || '');
          let arr = [];

          if (f.name.endsWith('.json')) {
            try {
              const j = JSON.parse(text);
              if (Array.isArray(j)) arr = j;
            } catch (e2) {
              alert('JSON íŒŒì‹± ì‹¤íŒ¨');
            }
          } else if (f.name.endsWith('.csv') || f.name.endsWith('.txt')) {
            arr = text
              .split(/[\r\n,]+/)
              .map(v => v.trim())
              .filter(Boolean);
          }

          arr.forEach(v => {
            if (!S.skills.includes(v)) S.skills.push(v);
          });
          drawSkills();
        };
        r.readAsText(f);
      };

      /* --- íƒ€ì„ë¼ì¸ ì¶”ê°€ --- */

      $id('tlAdd').onclick = () => {
        const date = $id('tlDate').value.trim();
        const text = $id('tlText').value.trim();
        if (!text) return;
        S.timeline.push({ date, text });
        $id('tlText').value = '';
        drawTimeline();
      };

      /* --- ë©¤ë²„ JSON ë‚´ë³´ë‚´ê¸° / ê°€ì ¸ì˜¤ê¸° --- */
      $id('exportBtn').onclick = exportMembers;
      $id('importInput').onchange = e => {
        const f = e.target.files && e.target.files[0];
        if (f) importMembersFromFile(f);
        e.target.value = '';   // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ ì´ˆê¸°í™”
      };

      // âœ… ì¶”ê°€: ë‹¨ì¼ ìºë¦­í„° ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ì—°ê²°
      const exportOneBtn   = $id('exportOneBtn');
      const importOneInput = $id('importOneInput');

      if (exportOneBtn) {
        exportOneBtn.onclick = exportCurrentMember;
      }

      if (importOneInput) {
        importOneInput.onchange = e => {
          const f = e.target.files && e.target.files[0];
          if (f) importSingleMemberFromFile(f);
          e.target.value = ''; // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
        };
      }


      /* --- ë„ê° í”¼ì»¤ ì—´ê¸°/ë‹«ê¸° & í•„í„° --- */

      const pickBtn  = $id('pickFromCodex');
      const closeBtn = $id('closePicker');

      if (pickBtn)  pickBtn.onclick  = openPicker;
      if (closeBtn) closeBtn.onclick = closePicker;

      // ëª¨ë‹¬ ë°”ê¹¥ìª½ í´ë¦­ â†’ ë‹«ê¸°
      if (codexModal) {
        codexModal.addEventListener('click', e => {
          if (e.target === codexModal) closePicker();
        });
      }

      // ë„ê° íƒ€ì… í•„í„° ë²„íŠ¼(ì „ì²´/íŠ¹ì„±/ê¸°ìˆ /â€¦)
      ['all','trait','tech','magic','skill','authority','blessing','proficiency']
        .forEach(type => {
          const btn = document.querySelector(
            `#codexModal .sleft [data-type="${type}"]`
          );
          if (btn) {
            btn.onclick = () => {
              cxFilterType = type;
              renderCxList();
            };
          }
        });

      // ê²€ìƒ‰ì–´/ë“±ê¸‰/ì •ë ¬ ë³€ê²½ â†’ ë¦¬ìŠ¤íŠ¸ ì¬ë Œë”ë§
      [cxQ, cxRank, cxSort].forEach(el => {
        if (el) el.addEventListener('input', renderCxList);
      });

      /* --- ë„ê°ì—ì„œ ì„ íƒí•œ í•­ëª©ì„ ìŠ¤í‚¬ ë°°ì—´ì— ì¶”ê°€ --- */

      if (cxAdd) {
        cxAdd.onclick = () => {
          if (!cxSelected) return;

          const name    = cxSelected.name || '';
          const rank    = cxSelected.rank || '';
          const type    = cxSelected.type || '';
          const codexId = cxSelected.id   || '';  // ë„ê° í•­ëª©ì˜ ê³ ìœ  id

          // ì´ë¯¸ ê°™ì€ codexId(ë˜ëŠ” name+rank) ìŠ¤í‚¬ì´ ìˆë‹¤ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
          if (!hasSkill(name, rank, codexId)) {
            S.skills.push({
              name,
              rank,
              type,
              codexId      // ë„ê° idë¥¼ ê°™ì´ ì €ì¥
            });
            drawSkills();
          }
        };
      }

      /* --- (ì„ íƒ) ì™¸ë¶€ JSON íŒŒì¼ ì—´ê¸°/ì €ì¥ (File System Access API) --- */

      const openBtn = document.getElementById('openDataBtn');
      const saveBtn = document.getElementById('saveDataBtn');

      if (openBtn || saveBtn) {
        let dataFileHandle = null;

        // OS íŒŒì¼ ì„ íƒ â†’ JSON ë°°ì—´ ë¡œë”©
        async function openDataFile() {
          try {
            const [handle] = await window.showOpenFilePicker({
              types: [{
                description: 'JSON',
                accept: { 'application/json': ['.json'] }
              }]
            });

            dataFileHandle = handle;
            const file = await dataFileHandle.getFile();
            const text = await file.text();
            const arr  = JSON.parse(text);

            if (Array.isArray(arr)) {
              S.list      = arr;
              S.currentId = null;
              S.skills    = [];
              S.timeline  = [];
              S.imgData   = '';
              drawList();
              alert('ì™¸ë¶€ JSONì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ì €ì¥ ì‹œ ê°™ì€ íŒŒì¼ì— ë®ì–´ì”ë‹ˆë‹¤.');
            } else {
              alert('JSON ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
            }
          } catch (err) {
            // ì‚¬ìš©ìê°€ ì·¨ì†Œí•œ ê²½ìš° ë“±ì€ ë¬´ì‹œ
          }
        }

        // í˜„ì¬ S.list â†’ ê°™ì€ JSON íŒŒì¼ì— ë®ì–´ì“°ê¸°
        async function saveToDataFile() {
          try {
            if (!dataFileHandle) {
              alert('ë¨¼ì € JSON íŒŒì¼ì„ ì—´ì–´ ì£¼ì„¸ìš”.');
              return;
            }
            const writable = await dataFileHandle.createWritable();
            await writable.write(
              new Blob([JSON.stringify(S.list, null, 2)], {
                type: 'application/json'
              })
            );
            await writable.close();
            alert('ì™¸ë¶€ JSON íŒŒì¼ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
          } catch (err) {
            console.error(err);
          }
        }

        if (openBtn) openBtn.onclick = openDataFile;
        if (saveBtn) saveBtn.onclick = saveToDataFile;
      }
    }

    /* =========================================================
    *  ì´ˆê¸° ì‹¤í–‰
    * ======================================================= */
    (async function init() {
      // 1) í˜„ì¬ ë¡œê·¸ì¸ ìœ ì € ì •ë³´(ê¶Œí•œ) ë¨¼ì € ë¡œë”©
      await loadCurrentUser();

      // 2) ë©¤ë²„ ëª©ë¡ ë¡œë“œ
      await loadInitialMembers(); // ì„œë²„/ë¡œì»¬ì—ì„œ ë©¤ë²„ ë¡œë”©

      // ğŸ”¹ 2-1) ì €ì¥ëœ ëŒ€í‘œ ìºë¦­í„°ê°€ ìˆìœ¼ë©´ ì„ íƒ ìƒíƒœ ë³µì›
      const repId = localStorage.getItem(REP);
      if (repId) {
        const repMember = S.list && S.list.find(c => c.id === repId);
        if (repMember) {
          S.currentId = repId;
        } else {
          // ëŒ€í‘œë¡œ ì§€ì •ëœ ìºë¦­í„°ê°€ ë” ì´ìƒ ì—†ìœ¼ë©´ ëŒ€í‘œ ì„¤ì •ë„ ì •ë¦¬
          localStorage.removeItem(REP);
        }
      }

      // 3) ìƒˆ ìºë¦­í„° ë²„íŠ¼ ë…¸ì¶œ ì—¬ë¶€ ì ìš© (admin + íŠ¹ìˆ˜ ì¡°ê±´)
      applyCreateButtonVisibility();

      // âœ… 3-1) ì¼ë°˜ ìœ ì €ëŠ” í¸ì§‘/ì €ì¥ ì ê¸ˆ
      applyEditLockForNonAdmin();

      // 4) ì´ ìœ ì €ì—ê²Œ ìºë¦­í„°ê°€ í•˜ë‚˜ë„ ì—†ë‹¤ë©´ â†’ ìƒì„± í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™
      if (!S.list || S.list.length === 0) {
        window.location.href = 'create.html';
        return;
      }

      // 5) ê¸°ì¡´ ë™ì‘
      bindEvents();               // ë²„íŠ¼/ì…ë ¥ ì´ë²¤íŠ¸ ì—°ê²°
      drawList();                 // ë¦¬ìŠ¤íŠ¸ ìµœì´ˆ ë Œë”
      setViewMode('list');        // ì²˜ìŒì—ëŠ” ë¦¬ìŠ¤íŠ¸ ìš°ì„  ëª¨ë“œ
    })();

  </script>
</body>
</html>