<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WORLD â€“ ì„¸ê³„ ì§€ë„</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- âœ… ê³µí†µ ìœ„ì¹˜ ë°ì´í„° ë¡œë“œ -->
  <script src="js/world-data.js"></script>

  <style>
    :root{
      --bg:#0f0f12;
      --panel:#18181f;
      --panel2:#121219;
      --text:#e8e6e3;
      --muted:#b7b3ad;
      --gold:#d4af37;
      --gold2:#b8922b;
      --card:rgba(212,175,55,.2);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Noto Sans KR',system-ui,sans-serif;
      background:radial-gradient(1200px 800px at 65% -10%, rgba(212,175,55,.22), transparent 60%),
                 radial-gradient(900px 600px at -10% 100%, rgba(93,188,210,.32), transparent 55%),
                 #050509;
      color:var(--text);
      overflow:hidden;
    }

    .app{
      position:relative;
      display:grid;
      grid-template-rows:auto 1fr auto;
      height:100vh;
      padding:16px;
      gap:16px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .top-left{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .logo-chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.4);
      border:1px solid rgba(255,255,255,.06);
      font-size:.85rem;
    }
    .logo-chip i{color:var(--gold);}

    .top-title{
      display:flex;
      flex-direction:column;
    }
    .top-title h1{
      font-family:'Cinzel',serif;
      font-size:1.1rem;
      margin:0;
      letter-spacing:.08em;
    }
    .top-title span{
      font-size:.8rem;
      color:var(--muted);
    }

    .top-right{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .chip{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.35);
      font-size:.8rem;
      display:flex;
      align-items:center;
      gap:6px;
      color:var(--muted);
    }
    .chip strong{color:var(--text);}

    .chip.link{
      cursor:pointer;
      text-decoration:none;
    }
    .chip.link:hover{
      background:rgba(212,175,55,.15);
      border-color:rgba(212,175,55,.6);
      color:var(--gold);
    }

    .main{
      display:grid;
      grid-template-columns:2.1fr 1.2fr;
      gap:16px;
      min-height:0;
    }

    .panel{
      border-radius:18px;
      background:linear-gradient(180deg, rgba(18,18,24,.9), rgba(10,10,16,.95));
      border:1px solid rgba(255,255,255,.06);
      box-shadow:0 18px 40px rgba(0,0,0,.55);
      padding:14px;
      position:relative;
      overflow:hidden;
    }

    .panel-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }

    .panel-header h2{
      margin:0;
      font-size:.95rem;
      letter-spacing:.05em;
      text-transform:uppercase;
      color:var(--muted);
    }

    .panel-header small{
      font-size:.75rem;
      color:var(--muted);
    }

    /* ğŸŒ ì›”ë“œ ë§µ ì˜ì—­ */
    .world-map-wrap{
      position:relative;
      width:100%;
      height:100%;
      border-radius:14px;
      overflow:hidden;
      background:#05060a;
      border:1px solid rgba(255,255,255,.06);
    }

    .world-map{
      position:relative;
      width:100%;
      height:100%;
    }

    .world-map img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter:saturate(1.1) contrast(1.05);
    }

    /* ğŸ”» ìºë¦­í„° ëª©ë¡ ì˜¤ë²„ë ˆì´ */
    .char-overlay{
      position:absolute;
      left:10px;
      right:10px;
      bottom:10px;
      display:flex;
      justify-content:flex-start;
      pointer-events:none;
    }

    .char-list{
      display:flex;
      gap:6px;
      padding:6px 8px;
      border-radius:999px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter:blur(10px);
      max-width:100%;
      overflow-x:auto;
      pointer-events:auto;
    }

    .char-item{
      border:none;
      background:transparent;
      display:flex;
      align-items:center;
      gap:6px;
      padding:3px 7px;
      border-radius:999px;
      cursor:pointer;
      color:var(--muted);
      font-size:.75rem;
      white-space:nowrap;
      transition:.16s;
    }

    .char-item img{
      width:22px;
      height:22px;
      border-radius:999px;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.4);
    }

    .char-item .tag{
      font-size:.7rem;
      opacity:.8;
    }

    .char-item .rep-badge{
      font-size:.65rem;
      padding:1px 4px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.3);
      background:rgba(0,0,0,.6);
      color:var(--gold2);
    }

    .char-item.active{
      background:linear-gradient(135deg,var(--gold),var(--gold2));
      color:#111;
    }

    .char-item.active img{
      border-color:rgba(0,0,0,.6);
    }

    .char-empty{
      font-size:.75rem;
      color:var(--muted);
      padding:2px 4px;
    }

    /* ğŸ”» ì§€ë„ ìœ„ ìºë¦­í„° ìœ„ì¹˜ ë§ˆì»¤ */
    .char-marker{
      position:absolute;
      transform:translate(-50%, -50%);
      width:10px;
      height:10px;
      border-radius:50%;
      background:rgba(212,175,55,.7);
      box-shadow:0 0 0 2px rgba(0,0,0,.7);
      pointer-events:none;
      opacity:.85;
    }

    .char-marker.current{
      width:12px;
      height:12px;
      box-shadow:0 0 14px rgba(212,175,55,.9);
    }

    .char-marker.flash{
      animation:charPing .4s ease-out;
    }

    @keyframes charPing{
      from{
        transform:translate(-50%, -50%) scale(0.8);
        opacity:.3;
      }
      to{
        transform:translate(-50%, -50%) scale(1.2);
        opacity:1;
      }
    }

    .country-pin{
      position:absolute;
      transform:translate(-50%, -50%);
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.35);
      background:rgba(5,5,10,.6);
      color:var(--text);
      font-size:.75rem;
      white-space:nowrap;
      backdrop-filter:blur(4px);
      cursor:pointer;
      transition:.18s ease;
    }
    .country-pin:hover{
      background:var(--card);
      border-color:var(--gold);
      transform:translate(-50%, -50%) translateY(-2px);
    }
    .country-pin.active{
      background:linear-gradient(135deg,var(--gold),var(--gold2));
      color:#111;
      border-color:rgba(0,0,0,.5);
    }
    .country-pin.pin-flash{
      animation:charPing .4s ease-out;
    }

    /* ğŸ° ë‚˜ë¼ ì •ë³´ íŒ¨ë„ */
    .country-info{
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:.85rem;
    }

    .country-name{
      font-size:1rem;
      font-weight:600;
    }

    .badge-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }

    .badge{
      padding:4px 8px;
      border-radius:999px;
      font-size:.7rem;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(0,0,0,.4);
      color:var(--muted);
    }

    .country-desc{
      margin-top:4px;
      color:var(--muted);
      line-height:1.5;
      white-space:pre-line;
    }

    .country-meta{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      margin-top:8px;
      font-size:.78rem;
      color:var(--muted);
    }

    .meta-item{
      padding:6px 8px;
      border-radius:10px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.04);
    }

    .meta-label{
      font-size:.7rem;
      color:rgba(183,179,173,.9);
    }

    .meta-value{
      font-size:.8rem;
    }

    .manage-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
    }

    .btn{
      flex:1;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.7);
      color:var(--text);
      font-size:.8rem;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      cursor:pointer;
      transition:.18s ease;
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--gold),var(--gold2));
      color:#111;
      border-color:rgba(0,0,0,.6);
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 24px rgba(0,0,0,.4);
    }

    /* í•˜ë‹¨ ë„¤ë¹„ */
    .bottomnav{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      background:linear-gradient(180deg, rgba(26,26,32,.9), rgba(10,10,16,.95));
      border-radius:16px;
      border:1px solid rgba(255,255,255,.06);
      backdrop-filter:blur(12px);
    }

    .navbtn{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:3px;
      padding:6px 10px;
      border-radius:999px;
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:.7rem;
      cursor:pointer;
      min-width:62px;
      transition:.18s ease;
    }
    .navbtn i{font-size:.9rem;}
    .navbtn:hover{
      background:rgba(255,255,255,.05);
      color:var(--text);
    }
    .navbtn.active{
      background:linear-gradient(135deg,var(--gold),var(--gold2));
      color:#111;
    }

    @media(max-width:900px){
      .app{
        padding:10px;
        gap:10px;
      }
      .main{
        grid-template-columns:1fr;
        grid-template-rows:1.3fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ìƒë‹¨ ë°” -->
    <header class="topbar">
      <div class="top-left">
        <div class="logo-chip">
          <i class="fa-solid fa-earth-asia"></i>
          <span style="font-size:.8rem;">WORLD MAP</span>
        </div>
        <div class="top-title">
          <h1>ì„¸ê³„ ì§€ë„</h1>
          <span>ë‚˜ë¼ë¥¼ ì„ íƒí•´ ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.</span>
        </div>
      </div>
      <div class="top-right">
        <a href="index.html" class="chip link">
          <i class="fa-solid fa-house"></i> í™ˆìœ¼ë¡œ
        </a>
      </div>
    </header>

    <!-- ë©”ì¸ ì˜ì—­ -->
    <main class="main">
      <!-- ğŸŒ ì§€ë„ íŒ¨ë„ -->
      <section class="panel">
        <div class="panel-header">
          <h2>WORLD MAP</h2>
          <small id="worldNameLabel">ê¸°ë³¸ ì›”ë“œ</small>
        </div>
        <div class="world-map-wrap">
          <div class="world-map" id="worldMap">
            <img src="images/world-map.png" alt="ì„¸ê³„ ì§€ë„">

            <!-- ìºë¦­í„° ëª©ë¡ ì˜¤ë²„ë ˆì´ -->
            <div class="char-overlay">
              <div class="char-list" id="charList"></div>
            </div>

            <!-- ë‚˜ë¼ í•€(ë²„íŠ¼)ë“¤ì´ JSë¡œ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
          </div>
        </div>
      </section>

      <!-- ğŸ° ë‚˜ë¼ ì •ë³´ íŒ¨ë„ -->
      <aside class="panel">
        <div class="panel-header">
          <h2>COUNTRY</h2>
          <small id="countryIdLabel">ë‚˜ë¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</small>
        </div>

        <div class="country-info">
          <div class="country-name" id="countryName">ì„ íƒëœ ë‚˜ë¼ ì—†ìŒ</div>
          <div class="badge-row" id="countryBadges"></div>
          <div class="country-desc" id="countryDesc">
            ì™¼ìª½ ì„¸ê³„ ì§€ë„ì—ì„œ ë‚˜ë¼ ì´ë¦„ì´ ìˆëŠ” êµ¬ì—­ì„ í´ë¦­í•˜ë©´,
            ì—¬ê¸°ì— í•´ë‹¹ êµ­ê°€ì˜ ìƒì„¸ ì •ë³´ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
          </div>

          <div class="country-meta">
            <div class="meta-item">
              <div class="meta-label">ì§€ì—­</div>
              <div class="meta-value" id="countryRegion">-</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">ì¤‘ì‹¬ ì„¸ë ¥</div>
              <div class="meta-value" id="countryFaction">-</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">ì¶”ì²œ ë ˆë²¨</div>
              <div class="meta-value" id="countryLevel">-</div>
            </div>
            <div class="meta-item">
              <div class="meta-label">ë¹„ê³ </div>
              <div class="meta-value" id="countryNote">-</div>
            </div>
          </div>
          <div class="manage-actions">
            <button class="btn primary" id="openManageBtn">
              <i class="fa-solid fa-pen-to-square"></i>
              ë‚˜ë¼ ê´€ë¦¬ í˜ì´ì§€ ì—´ê¸°
            </button>
            <button class="btn" id="centerOnMapBtn">
              <i class="fa-regular fa-compass"></i>
              ì§€ë„ì—ì„œ ì¤‘ì•™ìœ¼ë¡œ
            </button>
          </div>
        </div>
      </aside>
    </main>
    
    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="bottomnav">
      <button class="navbtn active" onclick="location.href='world.html'">
        <i class="fa-solid fa-earth-asia"></i><span>WORLD</span>
      </button>
      <button class="navbtn" onclick="location.href='member.html'">
        <i class="fa-regular fa-user"></i><span>MEMBER</span>
      </button>
      <button class="navbtn" onclick="location.href='character.html'">
        <i class="fa-regular fa-id-card"></i><span>PROFILE</span>
      </button>
      <button class="navbtn" onclick="location.href='compendium.html'">
        <i class="fa-regular fa-bookmark"></i><span>ë„ê°</span>
      </button>
      <button class="navbtn" onclick="location.href='battle.html'">
        <i class="fa-solid fa-swords"></i><span>BATTLE</span>
      </button>
      <button class="navbtn" onclick="location.href='equipment.html'">
        <i class="fa-solid fa-shield-halved"></i><span>EQUIP</span>
      </button>
      <button class="navbtn" onclick="location.href='inventory.html'">
        <i class="fa-solid fa-box-open"></i><span>INVENTORY</span>
      </button>
    </nav>
  </div>

  <!-- api.js ì‚¬ìš© -->
  <script src="api.js"></script>
  <script>
    // ğŸ“Œ ì§€ê¸ˆì€ í”„ë¡ íŠ¸ ìƒìˆ˜ë¡œë§Œ ì •ì˜í•´ë‘ê³ ,
    // ë‚˜ì¤‘ì— /api/worlds/world_default ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì‹ìœ¼ë¡œ êµì²´í•˜ë©´ ë¨.
    const WORLD_ID = 'world_default';

    const worldMapEl       = document.getElementById('worldMap');
    const countryNameEl    = document.getElementById('countryName');
    const countryIdLabelEl = document.getElementById('countryIdLabel');
    const countryDescEl    = document.getElementById('countryDesc');
    const countryRegionEl  = document.getElementById('countryRegion');
    const countryFactionEl = document.getElementById('countryFaction');
    const countryLevelEl   = document.getElementById('countryLevel');
    const countryNoteEl    = document.getElementById('countryNote');
    const countryBadgesEl  = document.getElementById('countryBadges');
    const openManageBtn    = document.getElementById('openManageBtn');
    const centerOnMapBtn   = document.getElementById('centerOnMapBtn');
    const charListEl       = document.getElementById('charList');

    let selectedCountry = null;
    let pins = [];

    function renderPins() {
      pins.forEach(p => p.remove());
      pins = [];

      (COUNTRIES || []).forEach(country => {
        const btn = document.createElement('button');
        btn.className = 'country-pin';
        btn.style.left = country.x + '%';
        btn.style.top  = country.y + '%';
        btn.textContent = country.name;
        btn.dataset.id = country.id;

        btn.addEventListener('click', () => {
          selectCountry(country.id);
        });

        worldMapEl.appendChild(btn);
        pins.push(btn);
      });
    }

    function selectCountry(countryId) {
      const country = (COUNTRIES || []).find(c => c.id === countryId);
      if (!country) return;

      selectedCountry = country;

      // ë²„íŠ¼ active í‘œì‹œ
      pins.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.id === country.id);
      });

      // ì •ë³´ íŒ¨ë„ ì—…ë°ì´íŠ¸ (ë‚˜ë¨¸ì§€ëŠ” ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
      countryNameEl.textContent    = country.name;
      countryIdLabelEl.textContent = country.id;
      countryRegionEl.textContent  = country.region  || '-';
      countryFactionEl.textContent = country.faction || '-';
      countryLevelEl.textContent   = country.level   || '-';
      countryNoteEl.textContent    = country.note    || '-';
      countryDescEl.textContent    = country.desc    || '';

      // ë±ƒì§€
      countryBadgesEl.innerHTML = '';
      (country.badges || []).forEach(text => {
        const span = document.createElement('span');
        span.className = 'badge';
        span.textContent = text;
        countryBadgesEl.appendChild(span);
      });
    }

    // ë‚˜ë¼ ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™
    openManageBtn.addEventListener('click', () => {
      if (!selectedCountry) {
        alert('ë¨¼ì € ì§€ë„ì˜ ë‚˜ë¼ë¥¼ í•˜ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }
      location.href = 'country.html?id=' + encodeURIComponent(selectedCountry.id);
    });

    // ì§€ë„ì—ì„œ í•´ë‹¹ ë‚˜ë¼ ê°•ì¡°
    centerOnMapBtn.addEventListener('click', () => {
      if (!selectedCountry) {
        alert('ë¨¼ì € ì§€ë„ì˜ ë‚˜ë¼ë¥¼ í•˜ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }
      const pin = pins.find(p => p.dataset.id === selectedCountry.id);
      if (pin) {
        pin.style.transition = 'transform 0.18s ease, box-shadow 0.18s ease';
        pin.style.boxShadow = '0 0 20px rgba(212,175,55,.8)';
        setTimeout(() => {
          pin.style.boxShadow = '';
        }, 400);
      }
    });

    /* =========================================================
     *  ì„œë²„ ë©¤ë²„(/api/members) ê¸°ë°˜ ìºë¦­í„° ëª©ë¡ / ìœ„ì¹˜ í‘œì‹œ
     *  - ë¡œì»¬ members.v1 ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
     * ======================================================= */

    const REP = 'representativeId'; // ëŒ€í‘œ ìºë¦­í„° id (ë¡œì»¬ì—ë§Œ ì €ì¥)

    let charMarkers   = [];
    let currentCharId = null;

    // ìºë¦­í„° â†’ ì–´ë–¤ êµ­ê°€ì— ì†í•˜ëŠ”ì§€ ì°¾ëŠ” í•¨ìˆ˜
    function resolveCharCountryId(ch) {
      return (
        ch.currentCountryId ||   // ì—¬í–‰/í˜„ì¬ ìœ„ì¹˜
        ch.locationCountryId ||  // ë‹¤ë¥¸ ì´ë¦„ í›„ë³´
        ch.homeCountryId   ||    // ì¶œì‹  êµ­ê°€
        ch.originCountryId ||    // ì¶œì‹  êµ­ê°€(ë‹¤ë¥¸ ì´ë¦„)
        ch.birthCountryId  ||    // ì¶œìƒ êµ­ê°€
        null
      );
    }

    // ë¦¬ìŠ¤íŠ¸/ë§ˆì»¤ active ìƒíƒœ ë™ê¸°í™”
    function syncCharMarkersActive() {
      if (!charListEl) return;

      const items = charListEl.querySelectorAll('.char-item');
      items.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.id === currentCharId);
      });

      charMarkers.forEach(m => {
        m.classList.toggle('current', m.dataset.id === currentCharId);
      });
    }

    // ì„œë²„ì—ì„œ ë©¤ë²„ë¥¼ ë¶ˆëŸ¬ì™€ ì§€ë„ì— í‘œì‹œ
    async function initWorldCharacters() {
      if (!charListEl || !worldMapEl) return;

      // ë¡œë”© ë©”ì‹œì§€
      charListEl.innerHTML = '<div class="char-empty">ìºë¦­í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

      let members = [];
      try {
        const serverList = await apiGet('/api/members');
        if (Array.isArray(serverList)) {
          members = serverList;
        }
      } catch (e) {
        console.error('ì„œë²„ ë©¤ë²„ ë¡œë“œ ì‹¤íŒ¨', e);
        charListEl.innerHTML =
          '<div class="char-empty">ì„œë²„ì—ì„œ ìºë¦­í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”)</div>';
        return;
      }

      // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
      charMarkers.forEach(m => m.remove());
      charMarkers = [];
      charListEl.innerHTML = '';

      if (!members.length) {
        const span = document.createElement('div');
        span.className = 'char-empty';
        span.textContent = 'ì„œë²„ì— ë“±ë¡ëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        charListEl.appendChild(span);
        return;
      }

      const repId = localStorage.getItem(REP);

      // ëŒ€í‘œ ìºë¦­í„°ê°€ ìˆìœ¼ë©´ ê·¸ê±¸, ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ìºë¦­í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ
      if (!currentCharId) {
        const hasRep = repId && members.some(m => m.id === repId);
        currentCharId = hasRep ? repId : members[0].id;
      }

      members.forEach(ch => {
        // ìºë¦­í„°ê°€ ì†í•œ êµ­ê°€ ID í™•ì¸ (ì—†ìœ¼ë©´ ì¤‘ì•™ ê· ì—´ ë„ì‹œ ê¸°ë³¸ê°’)
        let countryId = resolveCharCountryId(ch) || 'central_rift_city';
        let country   = (COUNTRIES || []).find(c => c.id === countryId);

        if (!country) {
          countryId = 'central_rift_city';
          country   = (COUNTRIES || []).find(c => c.id === countryId);
        }
        if (!country) return;

        // â”€ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìƒì„± â”€
        const btn = document.createElement('button');
        btn.className = 'char-item';
        btn.dataset.id = ch.id;

        const imgSrc   = ch.img || 'https://via.placeholder.com/80x80/1d1f26/777?text=NO+IMG';
        const roleText = ch.role || ch.jobName || 'ì§ì—… ë¯¸ì§€ì •';

        btn.innerHTML = `
          <img src="${imgSrc}" alt="">
          <span>${ch.name || 'ë¬´ëª…'}</span>
          <span class="tag">${country.name}</span>
          ${repId && ch.id === repId ? '<span class="rep-badge">ëŒ€í‘œ</span>' : ''}
        `;

        // í´ë¦­ ì‹œ: í•´ë‹¹ ìºë¦­í„°ê°€ ìˆëŠ” ë‚˜ë¼ë¡œ ì´ë™
        btn.addEventListener('click', () => {
          currentCharId = ch.id;

          selectCountry(country.id);

          const pin = pins.find(p => p.dataset.id === country.id);
          if (pin) {
            pin.classList.add('pin-flash');
            pin.style.transition = 'transform 0.18s ease, box-shadow 0.18s ease';
            pin.style.boxShadow = '0 0 20px rgba(212,175,55,.8)';
            setTimeout(() => {
              pin.style.boxShadow = '';
              pin.classList.remove('pin-flash');
            }, 400);
          }

          syncCharMarkersActive();
        });

        charListEl.appendChild(btn);

        // â”€ ì§€ë„ ìœ„ ë§ˆì»¤ ìƒì„± â”€
        const marker = document.createElement('div');
        marker.className = 'char-marker';
        marker.style.left = country.x + '%';
        marker.style.top  = country.y + '%';
        marker.dataset.id = ch.id;
        worldMapEl.appendChild(marker);
        charMarkers.push(marker);
      });

      syncCharMarkersActive();
    }

    // ìµœì´ˆ ë Œë”
    renderPins();
    selectCountry('central_rift_city');
    initWorldCharacters();

    // ğŸ“Œ ë‚˜ì¤‘ì— ì„œë²„ ì›”ë“œ ì—°ë™í•  ë•ŒëŠ”:
    // async function loadWorld() {
    //   const world = await apiGet('/api/worlds/' + WORLD_ID);
    //   // world.countries ë¥¼ countries ë°°ì—´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•´ì„œ renderPins í˜¸ì¶œ
    // }
  </script>
</body>
</html>
